<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>/Users/alainbloch/.gem/ruby/1.8/gems/activerecord-2.3.4/lib/active_record/associations.rb</title>
    <link href="screen.css" media="screen" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="rcov.js"></script>
  </head>
  <body>
    <h3>/Users/alainbloch/.gem/ruby/1.8/gems/activerecord-2.3.4/lib/active_record/associations.rb</h3>
    <p>Generated on Thu Dec 17 11:11:17 -0800 2009 with <a href="http://github.com/relevance/rcov">rcov 0.8.3.4</a></p>
    
    <hr />
      <pre>
        <span class='marked'>Code reported as executed by Ruby looks like this...</span><span class='marked1'>and this: this line is also marked as covered.</span><span class='inferred'>Lines considered as run by rcov, but not reported by Ruby, look like this,</span><span class='inferred1'>and this: these lines were inferred by rcov (using simple heuristics).</span><span class='uncovered'>Finally, here&apos;s a line marked as not executed.</span>
      </pre>
    <table class='report'>
      <thead>
        <tr>
          <td class='heading'>Name</td>
          <td class='heading'>Total lines</td>
          <td class='heading'>Lines of code</td>
          <td class='heading'>Total coverage</td>
          <td class='heading'>Code coverage</td>
        </tr>
      </thead>
      <tbody>
        <!-- alternate light/dark here -->
        <tr class='light'>
          <td>/Users/alainbloch/.gem/ruby/1.8/gems/activerecord-2.3.4/lib/active_record/associations.rb</td>
          <td class='lines_total'><tt>2238</tt></td>
          <td class='lines_code'><tt>982</tt></td>
          <td>
            <table cellspacing='0' cellpadding='0' align='right'>
              <tr>
                <td><tt class='coverage_total'>65.59%</tt>&nbsp;</td>
                <td>
                  <table cellspacing='0' class='percent_graph' cellpadding='0' width='100'>
                    <tr>
                      <td class='covered' width='66'></td>
                      <td class='uncovered' width='34'></td>
                    </tr>
                  </table>
                </td>
              </tr>
            </table>
          </td>
          <td>
            <table cellspacing='0' cellpadding='0' align='right'>
              <tr>
                <td><tt class='coverage_code'>27.90%</tt>&nbsp;</td>
                <td>
                  <table cellspacing='0' class='percent_graph' cellpadding='0' width='100'>
                    <tr>
                      <td class='covered' width='28'/>
                      <td class='uncovered' width='72'/>
                    </tr>
                  </table>
                </td>
              </tr>
            </table>
          </td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1"></a>1 module ActiveRecord</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line2"></a>2   class HasManyThroughAssociationNotFoundError < ActiveRecordError #:nodoc:</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line3"></a>3     def initialize(owner_class_name, reflection)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line4"></a>4       super("Could not find the association #{reflection.options[:through].inspect} in model #{owner_class_name}")</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line5"></a>5     end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line6"></a>6   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line7"></a>7 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line8"></a>8   class HasManyThroughAssociationPolymorphicError < ActiveRecordError #:nodoc:</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line9"></a>9     def initialize(owner_class_name, reflection, source_reflection)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line10"></a>10       super("Cannot have a has_many :through association '#{owner_class_name}##{reflection.name}' on the polymorphic object '#{source_reflection.class_name}##{source_reflection.name}'.")</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line11"></a>11     end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line12"></a>12   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line13"></a>13 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line14"></a>14   class HasManyThroughAssociationPointlessSourceTypeError < ActiveRecordError #:nodoc:</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line15"></a>15     def initialize(owner_class_name, reflection, source_reflection)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line16"></a>16       super("Cannot have a has_many :through association '#{owner_class_name}##{reflection.name}' with a :source_type option if the '#{reflection.through_reflection.class_name}##{source_reflection.name}' is not polymorphic.  Try removing :source_type on your association.")</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line17"></a>17     end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line18"></a>18   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line19"></a>19 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line20"></a>20   class HasManyThroughSourceAssociationNotFoundError < ActiveRecordError #:nodoc:</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line21"></a>21     def initialize(reflection)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line22"></a>22       through_reflection      = reflection.through_reflection</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line23"></a>23       source_reflection_names = reflection.source_reflection_names</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line24"></a>24       source_associations     = reflection.through_reflection.klass.reflect_on_all_associations.collect { |a| a.name.inspect }</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line25"></a>25       super("Could not find the source association(s) #{source_reflection_names.collect(&:inspect).to_sentence(:two_words_connector => ' or ', :last_word_connector => ', or ', :locale => :en)} in model #{through_reflection.klass}.  Try 'has_many #{reflection.name.inspect}, :through => #{through_reflection.name.inspect}, :source => <name>'.  Is it one of #{source_associations.to_sentence(:two_words_connector => ' or ', :last_word_connector => ', or ', :locale => :en)}?")</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line26"></a>26     end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line27"></a>27   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line28"></a>28 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line29"></a>29   class HasManyThroughSourceAssociationMacroError < ActiveRecordError #:nodoc:</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line30"></a>30     def initialize(reflection)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line31"></a>31       through_reflection = reflection.through_reflection</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line32"></a>32       source_reflection  = reflection.source_reflection</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line33"></a>33       super("Invalid source reflection macro :#{source_reflection.macro}#{" :through" if source_reflection.options[:through]} for has_many #{reflection.name.inspect}, :through => #{through_reflection.name.inspect}.  Use :source to specify the source reflection.")</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line34"></a>34     end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line35"></a>35   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line36"></a>36 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line37"></a>37   class HasManyThroughCantAssociateThroughHasOneOrManyReflection < ActiveRecordError #:nodoc:</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line38"></a>38     def initialize(owner, reflection)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line39"></a>39       super("Cannot modify association '#{owner.class.name}##{reflection.name}' because the source reflection class '#{reflection.source_reflection.class_name}' is associated to '#{reflection.through_reflection.class_name}' via :#{reflection.source_reflection.macro}.")</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line40"></a>40     end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line41"></a>41   end</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line42"></a>42   HasManyThroughCantAssociateThroughHasManyReflection = ActiveSupport::Deprecation::DeprecatedConstantProxy.new('ActiveRecord::HasManyThroughCantAssociateThroughHasManyReflection', 'ActiveRecord::HasManyThroughCantAssociateThroughHasOneOrManyReflection')</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line43"></a>43 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line44"></a>44   class HasManyThroughCantAssociateNewRecords < ActiveRecordError #:nodoc:</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line45"></a>45     def initialize(owner, reflection)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line46"></a>46       super("Cannot associate new records through '#{owner.class.name}##{reflection.name}' on '#{reflection.source_reflection.class_name rescue nil}##{reflection.source_reflection.name rescue nil}'. Both records must have an id in order to create the has_many :through record associating them.")</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line47"></a>47     end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line48"></a>48   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line49"></a>49 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line50"></a>50   class HasManyThroughCantDissociateNewRecords < ActiveRecordError #:nodoc:</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line51"></a>51     def initialize(owner, reflection)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line52"></a>52       super("Cannot dissociate new records through '#{owner.class.name}##{reflection.name}' on '#{reflection.source_reflection.class_name rescue nil}##{reflection.source_reflection.name rescue nil}'. Both records must have an id in order to delete the has_many :through record associating them.")</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line53"></a>53     end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line54"></a>54   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line55"></a>55 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line56"></a>56   class HasAndBelongsToManyAssociationForeignKeyNeeded < ActiveRecordError #:nodoc:</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line57"></a>57     def initialize(reflection)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line58"></a>58       super("Cannot create self referential has_and_belongs_to_many association on '#{reflection.class_name rescue nil}##{reflection.name rescue nil}'. :association_foreign_key cannot be the same as the :foreign_key.")</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line59"></a>59     end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line60"></a>60   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line61"></a>61 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line62"></a>62   class EagerLoadPolymorphicError < ActiveRecordError #:nodoc:</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line63"></a>63     def initialize(reflection)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line64"></a>64       super("Can not eagerly load the polymorphic association #{reflection.name.inspect}")</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line65"></a>65     end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line66"></a>66   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line67"></a>67 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line68"></a>68   class ReadOnlyAssociation < ActiveRecordError #:nodoc:</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line69"></a>69     def initialize(reflection)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line70"></a>70       super("Can not add to a has_many :through association.  Try adding to #{reflection.through_reflection.name.inspect}.")</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line71"></a>71     end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line72"></a>72   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line73"></a>73 </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line74"></a>74   # See ActiveRecord::Associations::ClassMethods for documentation.</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line75"></a>75   module Associations # :nodoc:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line76"></a>76     # These classes will be loaded when associations are created.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line77"></a>77     # So there is no need to eager load them.</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line78"></a>78     autoload :AssociationCollection, 'active_record/associations/association_collection'</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line79"></a>79     autoload :AssociationProxy, 'active_record/associations/association_proxy'</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line80"></a>80     autoload :BelongsToAssociation, 'active_record/associations/belongs_to_association'</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line81"></a>81     autoload :BelongsToPolymorphicAssociation, 'active_record/associations/belongs_to_polymorphic_association'</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line82"></a>82     autoload :HasAndBelongsToManyAssociation, 'active_record/associations/has_and_belongs_to_many_association'</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line83"></a>83     autoload :HasManyAssociation, 'active_record/associations/has_many_association'</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line84"></a>84     autoload :HasManyThroughAssociation, 'active_record/associations/has_many_through_association'</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line85"></a>85     autoload :HasOneAssociation, 'active_record/associations/has_one_association'</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line86"></a>86     autoload :HasOneThroughAssociation, 'active_record/associations/has_one_through_association'</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line87"></a>87 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line88"></a>88     def self.included(base)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line89"></a>89       base.extend(ClassMethods)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line90"></a>90     end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line91"></a>91 </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line92"></a>92     # Clears out the association cache</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line93"></a>93     def clear_association_cache #:nodoc:</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line94"></a>94       self.class.reflect_on_all_associations.to_a.each do |assoc|</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line95"></a>95         instance_variable_set "@#{assoc.name}", nil</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line96"></a>96       end unless self.new_record?</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line97"></a>97     end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line98"></a>98 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line99"></a>99     private</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line100"></a>100       # Gets the specified association instance if it responds to :loaded?, nil otherwise.</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line101"></a>101       def association_instance_get(name)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line102"></a>102         association = instance_variable_get("@#{name}")</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line103"></a>103         association if association.respond_to?(:loaded?)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line104"></a>104       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line105"></a>105 </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line106"></a>106       # Set the specified association instance.</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line107"></a>107       def association_instance_set(name, association)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line108"></a>108         instance_variable_set("@#{name}", association)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line109"></a>109       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line110"></a>110 </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line111"></a>111     # Associations are a set of macro-like class methods for tying objects together through foreign keys. They express relationships like</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line112"></a>112     # "Project has one Project Manager" or "Project belongs to a Portfolio". Each macro adds a number of methods to the class which are</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line113"></a>113     # specialized according to the collection or association symbol and the options hash. It works much the same way as Ruby's own <tt>attr*</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line114"></a>114     # methods. Example:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line115"></a>115     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line116"></a>116     #   class Project < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line117"></a>117     #     belongs_to              :portfolio</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line118"></a>118     #     has_one                 :project_manager</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line119"></a>119     #     has_many                :milestones</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line120"></a>120     #     has_and_belongs_to_many :categories</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line121"></a>121     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line122"></a>122     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line123"></a>123     # The project class now has the following methods (and more) to ease the traversal and manipulation of its relationships:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line124"></a>124     # * <tt>Project#portfolio, Project#portfolio=(portfolio), Project#portfolio.nil?</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line125"></a>125     # * <tt>Project#project_manager, Project#project_manager=(project_manager), Project#project_manager.nil?,</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line126"></a>126     # * <tt>Project#milestones.empty?, Project#milestones.size, Project#milestones, Project#milestones<<(milestone),</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line127"></a>127     #   <tt>Project#milestones.delete(milestone), Project#milestones.find(milestone_id), Project#milestones.find(:all, options),</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line128"></a>128     #   <tt>Project#milestones.build, Project#milestones.create</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line129"></a>129     # * <tt>Project#categories.empty?, Project#categories.size, Project#categories, Project#categories<<(category1),</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line130"></a>130     #   <tt>Project#categories.delete(category1)</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line131"></a>131     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line132"></a>132     # === A word of warning</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line133"></a>133     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line134"></a>134     # Don't create associations that have the same name as instance methods of ActiveRecord::Base. Since the association</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line135"></a>135     # adds a method with that name to its model, it will override the inherited method and break things.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line136"></a>136     # For instance, +attributes+ and +connection+ would be bad choices for association names.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line137"></a>137     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line138"></a>138     # == Auto-generated methods</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line139"></a>139     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line140"></a>140     # === Singular associations (one-to-one)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line141"></a>141     #                                     |            |  belongs_to  |</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line142"></a>142     #   generated methods                 | belongs_to | :polymorphic | has_one</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line143"></a>143     #   ----------------------------------+------------+--------------+---------</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line144"></a>144     #   other                             |     X      |      X       |    X</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line145"></a>145     #   other=(other)                     |     X      |      X       |    X</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line146"></a>146     #   build_other(attributes={})        |     X      |              |    X</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line147"></a>147     #   create_other(attributes={})       |     X      |              |    X</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line148"></a>148     #   other.create!(attributes={})      |            |              |    X</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line149"></a>149     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line150"></a>150     # ===Collection associations (one-to-many / many-to-many)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line151"></a>151     #                                     |       |          | has_many</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line152"></a>152     #   generated methods                 | habtm | has_many | :through</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line153"></a>153     #   ----------------------------------+-------+----------+----------</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line154"></a>154     #   others                            |   X   |    X     |    X</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line155"></a>155     #   others=(other,other,...)          |   X   |    X     |    X</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line156"></a>156     #   other_ids                         |   X   |    X     |    X</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line157"></a>157     #   other_ids=(id,id,...)             |   X   |    X     |    X</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line158"></a>158     #   others<<                          |   X   |    X     |    X</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line159"></a>159     #   others.push                       |   X   |    X     |    X</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line160"></a>160     #   others.concat                     |   X   |    X     |    X</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line161"></a>161     #   others.build(attributes={})       |   X   |    X     |    X</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line162"></a>162     #   others.create(attributes={})      |   X   |    X     |    X</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line163"></a>163     #   others.create!(attributes={})     |   X   |    X     |    X</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line164"></a>164     #   others.size                       |   X   |    X     |    X</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line165"></a>165     #   others.length                     |   X   |    X     |    X</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line166"></a>166     #   others.count                      |   X   |    X     |    X</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line167"></a>167     #   others.sum(args*,&block)          |   X   |    X     |    X</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line168"></a>168     #   others.empty?                     |   X   |    X     |    X</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line169"></a>169     #   others.clear                      |   X   |    X     |    X</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line170"></a>170     #   others.delete(other,other,...)    |   X   |    X     |    X</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line171"></a>171     #   others.delete_all                 |   X   |    X     |</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line172"></a>172     #   others.destroy_all                |   X   |    X     |    X</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line173"></a>173     #   others.find(*args)                |   X   |    X     |    X</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line174"></a>174     #   others.find_first                 |   X   |          |</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line175"></a>175     #   others.exists?                    |   X   |    X     |    X</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line176"></a>176     #   others.uniq                       |   X   |    X     |    X</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line177"></a>177     #   others.reset                      |   X   |    X     |    X</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line178"></a>178     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line179"></a>179     # == Cardinality and associations</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line180"></a>180     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line181"></a>181     # Active Record associations can be used to describe one-to-one, one-to-many and many-to-many</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line182"></a>182     # relationships between models. Each model uses an association to describe its role in</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line183"></a>183     # the relation. The +belongs_to+ association is always used in the model that has</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line184"></a>184     # the foreign key.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line185"></a>185     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line186"></a>186     # === One-to-one</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line187"></a>187     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line188"></a>188     # Use +has_one+ in the base, and +belongs_to+ in the associated model.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line189"></a>189     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line190"></a>190     #   class Employee < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line191"></a>191     #     has_one :office</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line192"></a>192     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line193"></a>193     #   class Office < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line194"></a>194     #     belongs_to :employee    # foreign key - employee_id</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line195"></a>195     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line196"></a>196     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line197"></a>197     # === One-to-many</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line198"></a>198     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line199"></a>199     # Use +has_many+ in the base, and +belongs_to+ in the associated model.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line200"></a>200     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line201"></a>201     #   class Manager < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line202"></a>202     #     has_many :employees</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line203"></a>203     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line204"></a>204     #   class Employee < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line205"></a>205     #     belongs_to :manager     # foreign key - manager_id</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line206"></a>206     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line207"></a>207     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line208"></a>208     # === Many-to-many</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line209"></a>209     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line210"></a>210     # There are two ways to build a many-to-many relationship.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line211"></a>211     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line212"></a>212     # The first way uses a +has_many+ association with the <tt>:through</tt> option and a join model, so</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line213"></a>213     # there are two stages of associations.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line214"></a>214     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line215"></a>215     #   class Assignment < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line216"></a>216     #     belongs_to :programmer  # foreign key - programmer_id</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line217"></a>217     #     belongs_to :project     # foreign key - project_id</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line218"></a>218     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line219"></a>219     #   class Programmer < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line220"></a>220     #     has_many :assignments</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line221"></a>221     #     has_many :projects, :through => :assignments</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line222"></a>222     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line223"></a>223     #   class Project < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line224"></a>224     #     has_many :assignments</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line225"></a>225     #     has_many :programmers, :through => :assignments</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line226"></a>226     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line227"></a>227     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line228"></a>228     # For the second way, use +has_and_belongs_to_many+ in both models. This requires a join table</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line229"></a>229     # that has no corresponding model or primary key.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line230"></a>230     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line231"></a>231     #   class Programmer < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line232"></a>232     #     has_and_belongs_to_many :projects       # foreign keys in the join table</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line233"></a>233     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line234"></a>234     #   class Project < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line235"></a>235     #     has_and_belongs_to_many :programmers    # foreign keys in the join table</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line236"></a>236     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line237"></a>237     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line238"></a>238     # Choosing which way to build a many-to-many relationship is not always simple.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line239"></a>239     # If you need to work with the relationship model as its own entity,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line240"></a>240     # use <tt>has_many :through</tt>. Use +has_and_belongs_to_many+ when working with legacy schemas or when</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line241"></a>241     # you never work directly with the relationship itself.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line242"></a>242     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line243"></a>243     # == Is it a +belongs_to+ or +has_one+ association?</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line244"></a>244     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line245"></a>245     # Both express a 1-1 relationship. The difference is mostly where to place the foreign key, which goes on the table for the class</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line246"></a>246     # declaring the +belongs_to+ relationship. Example:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line247"></a>247     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line248"></a>248     #   class User < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line249"></a>249     #     # I reference an account.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line250"></a>250     #     belongs_to :account</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line251"></a>251     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line252"></a>252     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line253"></a>253     #   class Account < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line254"></a>254     #     # One user references me.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line255"></a>255     #     has_one :user</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line256"></a>256     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line257"></a>257     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line258"></a>258     # The tables for these classes could look something like:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line259"></a>259     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line260"></a>260     #   CREATE TABLE users (</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line261"></a>261     #     id int(11) NOT NULL auto_increment,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line262"></a>262     #     account_id int(11) default NULL,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line263"></a>263     #     name varchar default NULL,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line264"></a>264     #     PRIMARY KEY  (id)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line265"></a>265     #   )</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line266"></a>266     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line267"></a>267     #   CREATE TABLE accounts (</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line268"></a>268     #     id int(11) NOT NULL auto_increment,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line269"></a>269     #     name varchar default NULL,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line270"></a>270     #     PRIMARY KEY  (id)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line271"></a>271     #   )</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line272"></a>272     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line273"></a>273     # == Unsaved objects and associations</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line274"></a>274     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line275"></a>275     # You can manipulate objects and associations before they are saved to the database, but there is some special behavior you should be</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line276"></a>276     # aware of, mostly involving the saving of associated objects.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line277"></a>277     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line278"></a>278     # Unless you enable the :autosave option on a <tt>has_one</tt>, <tt>belongs_to</tt>,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line279"></a>279     # <tt>has_many</tt>, or <tt>has_and_belongs_to_many</tt> association,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line280"></a>280     # in which case the members are always saved.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line281"></a>281     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line282"></a>282     # === One-to-one associations</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line283"></a>283     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line284"></a>284     # * Assigning an object to a +has_one+ association automatically saves that object and the object being replaced (if there is one), in</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line285"></a>285     #   order to update their primary keys - except if the parent object is unsaved (<tt>new_record? == true</tt>).</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line286"></a>286     # * If either of these saves fail (due to one of the objects being invalid) the assignment statement returns +false+ and the assignment</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line287"></a>287     #   is cancelled.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line288"></a>288     # * If you wish to assign an object to a +has_one+ association without saving it, use the <tt>association.build</tt> method (documented below).</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line289"></a>289     # * Assigning an object to a +belongs_to+ association does not save the object, since the foreign key field belongs on the parent. It</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line290"></a>290     #   does not save the parent either.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line291"></a>291     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line292"></a>292     # === Collections</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line293"></a>293     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line294"></a>294     # * Adding an object to a collection (+has_many+ or +has_and_belongs_to_many+) automatically saves that object, except if the parent object</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line295"></a>295     #   (the owner of the collection) is not yet stored in the database.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line296"></a>296     # * If saving any of the objects being added to a collection (via <tt>push</tt> or similar) fails, then <tt>push</tt> returns +false+.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line297"></a>297     # * You can add an object to a collection without automatically saving it by using the <tt>collection.build</tt> method (documented below).</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line298"></a>298     # * All unsaved (<tt>new_record? == true</tt>) members of the collection are automatically saved when the parent is saved.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line299"></a>299     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line300"></a>300     # === Association callbacks</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line301"></a>301     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line302"></a>302     # Similar to the normal callbacks that hook into the lifecycle of an Active Record object, you can also define callbacks that get</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line303"></a>303     # triggered when you add an object to or remove an object from an association collection. Example:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line304"></a>304     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line305"></a>305     #   class Project</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line306"></a>306     #     has_and_belongs_to_many :developers, :after_add => :evaluate_velocity</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line307"></a>307     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line308"></a>308     #     def evaluate_velocity(developer)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line309"></a>309     #       ...</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line310"></a>310     #     end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line311"></a>311     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line312"></a>312     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line313"></a>313     # It's possible to stack callbacks by passing them as an array. Example:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line314"></a>314     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line315"></a>315     #   class Project</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line316"></a>316     #     has_and_belongs_to_many :developers, :after_add => [:evaluate_velocity, Proc.new { |p, d| p.shipping_date = Time.now}]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line317"></a>317     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line318"></a>318     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line319"></a>319     # Possible callbacks are: +before_add+, +after_add+, +before_remove+ and +after_remove+.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line320"></a>320     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line321"></a>321     # Should any of the +before_add+ callbacks throw an exception, the object does not get added to the collection. Same with</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line322"></a>322     # the +before_remove+ callbacks; if an exception is thrown the object doesn't get removed.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line323"></a>323     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line324"></a>324     # === Association extensions</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line325"></a>325     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line326"></a>326     # The proxy objects that control the access to associations can be extended through anonymous modules. This is especially</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line327"></a>327     # beneficial for adding new finders, creators, and other factory-type methods that are only used as part of this association.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line328"></a>328     # Example:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line329"></a>329     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line330"></a>330     #   class Account < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line331"></a>331     #     has_many :people do</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line332"></a>332     #       def find_or_create_by_name(name)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line333"></a>333     #         first_name, last_name = name.split(" ", 2)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line334"></a>334     #         find_or_create_by_first_name_and_last_name(first_name, last_name)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line335"></a>335     #       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line336"></a>336     #     end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line337"></a>337     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line338"></a>338     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line339"></a>339     #   person = Account.find(:first).people.find_or_create_by_name("David Heinemeier Hansson")</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line340"></a>340     #   person.first_name # => "David"</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line341"></a>341     #   person.last_name  # => "Heinemeier Hansson"</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line342"></a>342     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line343"></a>343     # If you need to share the same extensions between many associations, you can use a named extension module. Example:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line344"></a>344     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line345"></a>345     #   module FindOrCreateByNameExtension</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line346"></a>346     #     def find_or_create_by_name(name)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line347"></a>347     #       first_name, last_name = name.split(" ", 2)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line348"></a>348     #       find_or_create_by_first_name_and_last_name(first_name, last_name)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line349"></a>349     #     end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line350"></a>350     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line351"></a>351     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line352"></a>352     #   class Account < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line353"></a>353     #     has_many :people, :extend => FindOrCreateByNameExtension</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line354"></a>354     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line355"></a>355     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line356"></a>356     #   class Company < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line357"></a>357     #     has_many :people, :extend => FindOrCreateByNameExtension</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line358"></a>358     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line359"></a>359     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line360"></a>360     # If you need to use multiple named extension modules, you can specify an array of modules with the <tt>:extend</tt> option.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line361"></a>361     # In the case of name conflicts between methods in the modules, methods in modules later in the array supercede</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line362"></a>362     # those earlier in the array. Example:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line363"></a>363     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line364"></a>364     #   class Account < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line365"></a>365     #     has_many :people, :extend => [FindOrCreateByNameExtension, FindRecentExtension]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line366"></a>366     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line367"></a>367     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line368"></a>368     # Some extensions can only be made to work with knowledge of the association proxy's internals.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line369"></a>369     # Extensions can access relevant state using accessors on the association proxy:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line370"></a>370     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line371"></a>371     # * +proxy_owner+ - Returns the object the association is part of.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line372"></a>372     # * +proxy_reflection+ - Returns the reflection object that describes the association.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line373"></a>373     # * +proxy_target+ - Returns the associated object for +belongs_to+ and +has_one+, or the collection of associated objects for +has_many+ and +has_and_belongs_to_many+.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line374"></a>374     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line375"></a>375     # === Association Join Models</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line376"></a>376     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line377"></a>377     # Has Many associations can be configured with the <tt>:through</tt> option to use an explicit join model to retrieve the data.  This</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line378"></a>378     # operates similarly to a +has_and_belongs_to_many+ association.  The advantage is that you're able to add validations,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line379"></a>379     # callbacks, and extra attributes on the join model.  Consider the following schema:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line380"></a>380     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line381"></a>381     #   class Author < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line382"></a>382     #     has_many :authorships</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line383"></a>383     #     has_many :books, :through => :authorships</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line384"></a>384     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line385"></a>385     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line386"></a>386     #   class Authorship < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line387"></a>387     #     belongs_to :author</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line388"></a>388     #     belongs_to :book</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line389"></a>389     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line390"></a>390     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line391"></a>391     #   @author = Author.find :first</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line392"></a>392     #   @author.authorships.collect { |a| a.book } # selects all books that the author's authorships belong to.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line393"></a>393     #   @author.books                              # selects all books by using the Authorship join model</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line394"></a>394     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line395"></a>395     # You can also go through a +has_many+ association on the join model:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line396"></a>396     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line397"></a>397     #   class Firm < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line398"></a>398     #     has_many   :clients</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line399"></a>399     #     has_many   :invoices, :through => :clients</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line400"></a>400     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line401"></a>401     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line402"></a>402     #   class Client < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line403"></a>403     #     belongs_to :firm</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line404"></a>404     #     has_many   :invoices</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line405"></a>405     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line406"></a>406     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line407"></a>407     #   class Invoice < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line408"></a>408     #     belongs_to :client</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line409"></a>409     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line410"></a>410     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line411"></a>411     #   @firm = Firm.find :first</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line412"></a>412     #   @firm.clients.collect { |c| c.invoices }.flatten # select all invoices for all clients of the firm</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line413"></a>413     #   @firm.invoices                                   # selects all invoices by going through the Client join model.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line414"></a>414     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line415"></a>415     # Similarly you can go through a +has_one+ association on the join model:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line416"></a>416     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line417"></a>417     #   class Group < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line418"></a>418     #     has_many   :users</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line419"></a>419     #     has_many   :avatars, :through => :users</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line420"></a>420     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line421"></a>421     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line422"></a>422     #   class User < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line423"></a>423     #     belongs_to :group</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line424"></a>424     #     has_one    :avatar</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line425"></a>425     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line426"></a>426     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line427"></a>427     #   class Avatar < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line428"></a>428     #     belongs_to :user</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line429"></a>429     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line430"></a>430     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line431"></a>431     #   @group = Group.first</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line432"></a>432     #   @group.users.collect { |u| u.avatar }.flatten # select all avatars for all users in the group</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line433"></a>433     #   @group.avatars                                # selects all avatars by going through the User join model.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line434"></a>434     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line435"></a>435     # An important caveat with going through +has_one+ or +has_many+ associations on the join model is that these associations are </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line436"></a>436     # *read-only*.  For example, the following would not work following the previous example:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line437"></a>437     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line438"></a>438     #   @group.avatars << Avatar.new                # this would work if User belonged_to Avatar rather than the other way around.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line439"></a>439     #   @group.avatars.delete(@group.avatars.last)  # so would this</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line440"></a>440     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line441"></a>441     # === Polymorphic Associations</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line442"></a>442     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line443"></a>443     # Polymorphic associations on models are not restricted on what types of models they can be associated with.  Rather, they</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line444"></a>444     # specify an interface that a +has_many+ association must adhere to.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line445"></a>445     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line446"></a>446     #   class Asset < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line447"></a>447     #     belongs_to :attachable, :polymorphic => true</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line448"></a>448     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line449"></a>449     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line450"></a>450     #   class Post < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line451"></a>451     #     has_many :assets, :as => :attachable         # The :as option specifies the polymorphic interface to use.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line452"></a>452     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line453"></a>453     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line454"></a>454     #   @asset.attachable = @post</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line455"></a>455     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line456"></a>456     # This works by using a type column in addition to a foreign key to specify the associated record.  In the Asset example, you'd need</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line457"></a>457     # an +attachable_id+ integer column and an +attachable_type+ string column.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line458"></a>458     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line459"></a>459     # Using polymorphic associations in combination with single table inheritance (STI) is a little tricky. In order</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line460"></a>460     # for the associations to work as expected, ensure that you store the base model for the STI models in the</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line461"></a>461     # type column of the polymorphic association. To continue with the asset example above, suppose there are guest posts</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line462"></a>462     # and member posts that use the posts table for STI. In this case, there must be a +type+ column in the posts table.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line463"></a>463     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line464"></a>464     #   class Asset < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line465"></a>465     #     belongs_to :attachable, :polymorphic => true</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line466"></a>466     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line467"></a>467     #     def attachable_type=(sType)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line468"></a>468     #        super(sType.to_s.classify.constantize.base_class.to_s)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line469"></a>469     #     end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line470"></a>470     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line471"></a>471     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line472"></a>472     #   class Post < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line473"></a>473     #     # because we store "Post" in attachable_type now :dependent => :destroy will work</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line474"></a>474     #     has_many :assets, :as => :attachable, :dependent => :destroy</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line475"></a>475     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line476"></a>476     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line477"></a>477     #   class GuestPost < Post</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line478"></a>478     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line479"></a>479     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line480"></a>480     #   class MemberPost < Post</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line481"></a>481     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line482"></a>482     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line483"></a>483     # == Caching</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line484"></a>484     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line485"></a>485     # All of the methods are built on a simple caching principle that will keep the result of the last query around unless specifically</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line486"></a>486     # instructed not to. The cache is even shared across methods to make it even cheaper to use the macro-added methods without</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line487"></a>487     # worrying too much about performance at the first go. Example:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line488"></a>488     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line489"></a>489     #   project.milestones             # fetches milestones from the database</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line490"></a>490     #   project.milestones.size        # uses the milestone cache</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line491"></a>491     #   project.milestones.empty?      # uses the milestone cache</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line492"></a>492     #   project.milestones(true).size  # fetches milestones from the database</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line493"></a>493     #   project.milestones             # uses the milestone cache</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line494"></a>494     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line495"></a>495     # == Eager loading of associations</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line496"></a>496     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line497"></a>497     # Eager loading is a way to find objects of a certain class and a number of named associations. This is</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line498"></a>498     # one of the easiest ways of to prevent the dreaded 1+N problem in which fetching 100 posts that each need to display their author</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line499"></a>499     # triggers 101 database queries. Through the use of eager loading, the 101 queries can be reduced to 2. Example:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line500"></a>500     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line501"></a>501     #   class Post < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line502"></a>502     #     belongs_to :author</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line503"></a>503     #     has_many   :comments</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line504"></a>504     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line505"></a>505     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line506"></a>506     # Consider the following loop using the class above:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line507"></a>507     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line508"></a>508     #   for post in Post.all</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line509"></a>509     #     puts "Post:            " + post.title</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line510"></a>510     #     puts "Written by:      " + post.author.name</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line511"></a>511     #     puts "Last comment on: " + post.comments.first.created_on</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line512"></a>512     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line513"></a>513     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line514"></a>514     # To iterate over these one hundred posts, we'll generate 201 database queries. Let's first just optimize it for retrieving the author:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line515"></a>515     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line516"></a>516     #   for post in Post.find(:all, :include => :author)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line517"></a>517     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line518"></a>518     # This references the name of the +belongs_to+ association that also used the <tt>:author</tt> symbol. After loading the posts, find</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line519"></a>519     # will collect the +author_id+ from each one and load all the referenced authors with one query. Doing so will cut down the number of queries from 201 to 102.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line520"></a>520     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line521"></a>521     # We can improve upon the situation further by referencing both associations in the finder with:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line522"></a>522     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line523"></a>523     #   for post in Post.find(:all, :include => [ :author, :comments ])</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line524"></a>524     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line525"></a>525     # This will load all comments with a single query. This reduces the total number of queries to 3. More generally the number of queries</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line526"></a>526     # will be 1 plus the number of associations named (except if some of the associations are polymorphic +belongs_to+ - see below).</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line527"></a>527     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line528"></a>528     # To include a deep hierarchy of associations, use a hash:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line529"></a>529     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line530"></a>530     #   for post in Post.find(:all, :include => [ :author, { :comments => { :author => :gravatar } } ])</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line531"></a>531     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line532"></a>532     # That'll grab not only all the comments but all their authors and gravatar pictures.  You can mix and match</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line533"></a>533     # symbols, arrays and hashes in any combination to describe the associations you want to load.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line534"></a>534     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line535"></a>535     # All of this power shouldn't fool you into thinking that you can pull out huge amounts of data with no performance penalty just because you've reduced</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line536"></a>536     # the number of queries. The database still needs to send all the data to Active Record and it still needs to be processed. So it's no</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line537"></a>537     # catch-all for performance problems, but it's a great way to cut down on the number of queries in a situation as the one described above.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line538"></a>538     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line539"></a>539     # Since only one table is loaded at a time, conditions or orders cannot reference tables other than the main one. If this is the case</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line540"></a>540     # Active Record falls back to the previously used LEFT OUTER JOIN based strategy. For example</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line541"></a>541     #  </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line542"></a>542     #   Post.find(:all, :include => [ :author, :comments ], :conditions => ['comments.approved = ?', true])</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line543"></a>543     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line544"></a>544     # will result in a single SQL query with joins along the lines of: <tt>LEFT OUTER JOIN comments ON comments.post_id = posts.id</tt> and</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line545"></a>545     # <tt>LEFT OUTER JOIN authors ON authors.id = posts.author_id</tt>. Note that using conditions like this can have unintended consequences.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line546"></a>546     # In the above example posts with no approved comments are not returned at all, because the conditions apply to the SQL statement as a whole</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line547"></a>547     # and not just to the association. You must disambiguate column references for this fallback to happen, for example</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line548"></a>548     # <tt>:order => "author.name DESC"</tt> will work but <tt>:order => "name DESC"</tt> will not. </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line549"></a>549     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line550"></a>550     # If you do want eagerload only some members of an association it is usually more natural to <tt>:include</tt> an association</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line551"></a>551     # which has conditions defined on it:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line552"></a>552     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line553"></a>553     #   class Post < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line554"></a>554     #     has_many :approved_comments, :class_name => 'Comment', :conditions => ['approved = ?', true]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line555"></a>555     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line556"></a>556     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line557"></a>557     #   Post.find(:all, :include => :approved_comments)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line558"></a>558     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line559"></a>559     # will load posts and eager load the +approved_comments+ association, which contains only those comments that have been approved.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line560"></a>560     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line561"></a>561     # If you eager load an association with a specified <tt>:limit</tt> option, it will be ignored, returning all the associated objects:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line562"></a>562     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line563"></a>563     #   class Picture < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line564"></a>564     #     has_many :most_recent_comments, :class_name => 'Comment', :order => 'id DESC', :limit => 10</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line565"></a>565     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line566"></a>566     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line567"></a>567     #   Picture.find(:first, :include => :most_recent_comments).most_recent_comments # => returns all associated comments.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line568"></a>568     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line569"></a>569     # When eager loaded, conditions are interpolated in the context of the model class, not the model instance.  Conditions are lazily interpolated</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line570"></a>570     # before the actual model exists.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line571"></a>571     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line572"></a>572     # Eager loading is supported with polymorphic associations.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line573"></a>573     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line574"></a>574     #   class Address < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line575"></a>575     #     belongs_to :addressable, :polymorphic => true</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line576"></a>576     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line577"></a>577     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line578"></a>578     # A call that tries to eager load the addressable model</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line579"></a>579     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line580"></a>580     #   Address.find(:all, :include => :addressable)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line581"></a>581     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line582"></a>582     # will execute one query to load the addresses and load the addressables with one query per addressable type. </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line583"></a>583     # For example if all the addressables are either of class Person or Company then a total of 3 queries will be executed. The list of</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line584"></a>584     # addressable types to load is determined on the back of the addresses loaded. This is not supported if Active Record has to fallback</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line585"></a>585     # to the previous implementation of eager loading and will raise ActiveRecord::EagerLoadPolymorphicError. The reason is that the parent </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line586"></a>586     # model's type is a column value so its corresponding table name cannot be put in the +FROM+/+JOIN+ clauses of that query.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line587"></a>587     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line588"></a>588     # == Table Aliasing</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line589"></a>589     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line590"></a>590     # Active Record uses table aliasing in the case that a table is referenced multiple times in a join.  If a table is referenced only once,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line591"></a>591     # the standard table name is used.  The second time, the table is aliased as <tt>#{reflection_name}_#{parent_table_name}</tt>.  Indexes are appended</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line592"></a>592     # for any more successive uses of the table name.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line593"></a>593     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line594"></a>594     #   Post.find :all, :joins => :comments</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line595"></a>595     #   # => SELECT ... FROM posts INNER JOIN comments ON ...</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line596"></a>596     #   Post.find :all, :joins => :special_comments # STI</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line597"></a>597     #   # => SELECT ... FROM posts INNER JOIN comments ON ... AND comments.type = 'SpecialComment'</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line598"></a>598     #   Post.find :all, :joins => [:comments, :special_comments] # special_comments is the reflection name, posts is the parent table name</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line599"></a>599     #   # => SELECT ... FROM posts INNER JOIN comments ON ... INNER JOIN comments special_comments_posts</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line600"></a>600     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line601"></a>601     # Acts as tree example:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line602"></a>602     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line603"></a>603     #   TreeMixin.find :all, :joins => :children</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line604"></a>604     #   # => SELECT ... FROM mixins INNER JOIN mixins childrens_mixins ...</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line605"></a>605     #   TreeMixin.find :all, :joins => {:children => :parent}</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line606"></a>606     #   # => SELECT ... FROM mixins INNER JOIN mixins childrens_mixins ...</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line607"></a>607     #                               INNER JOIN parents_mixins ...</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line608"></a>608     #   TreeMixin.find :all, :joins => {:children => {:parent => :children}}</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line609"></a>609     #   # => SELECT ... FROM mixins INNER JOIN mixins childrens_mixins ...</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line610"></a>610     #                               INNER JOIN parents_mixins ...</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line611"></a>611     #                               INNER JOIN mixins childrens_mixins_2</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line612"></a>612     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line613"></a>613     # Has and Belongs to Many join tables use the same idea, but add a <tt>_join</tt> suffix:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line614"></a>614     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line615"></a>615     #   Post.find :all, :joins => :categories</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line616"></a>616     #   # => SELECT ... FROM posts INNER JOIN categories_posts ... INNER JOIN categories ...</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line617"></a>617     #   Post.find :all, :joins => {:categories => :posts}</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line618"></a>618     #   # => SELECT ... FROM posts INNER JOIN categories_posts ... INNER JOIN categories ...</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line619"></a>619     #                              INNER JOIN categories_posts posts_categories_join INNER JOIN posts posts_categories</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line620"></a>620     #   Post.find :all, :joins => {:categories => {:posts => :categories}}</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line621"></a>621     #   # => SELECT ... FROM posts INNER JOIN categories_posts ... INNER JOIN categories ...</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line622"></a>622     #                              INNER JOIN categories_posts posts_categories_join INNER JOIN posts posts_categories</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line623"></a>623     #                              INNER JOIN categories_posts categories_posts_join INNER JOIN categories categories_posts_2</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line624"></a>624     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line625"></a>625     # If you wish to specify your own custom joins using a <tt>:joins</tt> option, those table names will take precedence over the eager associations:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line626"></a>626     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line627"></a>627     #   Post.find :all, :joins => :comments, :joins => "inner join comments ..."</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line628"></a>628     #   # => SELECT ... FROM posts INNER JOIN comments_posts ON ... INNER JOIN comments ...</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line629"></a>629     #   Post.find :all, :joins => [:comments, :special_comments], :joins => "inner join comments ..."</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line630"></a>630     #   # => SELECT ... FROM posts INNER JOIN comments comments_posts ON ...</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line631"></a>631     #                              INNER JOIN comments special_comments_posts ...</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line632"></a>632     #                              INNER JOIN comments ...</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line633"></a>633     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line634"></a>634     # Table aliases are automatically truncated according to the maximum length of table identifiers according to the specific database.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line635"></a>635     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line636"></a>636     # == Modules</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line637"></a>637     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line638"></a>638     # By default, associations will look for objects within the current module scope. Consider:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line639"></a>639     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line640"></a>640     #   module MyApplication</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line641"></a>641     #     module Business</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line642"></a>642     #       class Firm < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line643"></a>643     #          has_many :clients</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line644"></a>644     #        end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line645"></a>645     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line646"></a>646     #       class Client < ActiveRecord::Base; end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line647"></a>647     #     end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line648"></a>648     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line649"></a>649     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line650"></a>650     # When <tt>Firm#clients</tt> is called, it will in turn call <tt>MyApplication::Business::Client.find_all_by_firm_id(firm.id)</tt>.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line651"></a>651     # If you want to associate with a class in another module scope, this can be done by specifying the complete class name.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line652"></a>652     # Example:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line653"></a>653     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line654"></a>654     #   module MyApplication</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line655"></a>655     #     module Business</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line656"></a>656     #       class Firm < ActiveRecord::Base; end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line657"></a>657     #     end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line658"></a>658     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line659"></a>659     #     module Billing</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line660"></a>660     #       class Account < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line661"></a>661     #         belongs_to :firm, :class_name => "MyApplication::Business::Firm"</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line662"></a>662     #       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line663"></a>663     #     end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line664"></a>664     #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line665"></a>665     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line666"></a>666     # == Type safety with <tt>ActiveRecord::AssociationTypeMismatch</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line667"></a>667     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line668"></a>668     # If you attempt to assign an object to an association that doesn't match the inferred or specified <tt>:class_name</tt>, you'll</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line669"></a>669     # get an <tt>ActiveRecord::AssociationTypeMismatch</tt>.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line670"></a>670     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line671"></a>671     # == Options</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line672"></a>672     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line673"></a>673     # All of the association macros can be specialized through options. This makes cases more complex than the simple and guessable ones</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line674"></a>674     # possible.</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line675"></a>675     module ClassMethods</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line676"></a>676       # Specifies a one-to-many association. The following methods for retrieval and query of</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line677"></a>677       # collections of associated objects will be added:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line678"></a>678       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line679"></a>679       # [collection(force_reload = false)]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line680"></a>680       #   Returns an array of all the associated objects.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line681"></a>681       #   An empty array is returned if none are found.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line682"></a>682       # [collection<<(object, ...)]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line683"></a>683       #   Adds one or more objects to the collection by setting their foreign keys to the collection's primary key.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line684"></a>684       # [collection.delete(object, ...)]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line685"></a>685       #   Removes one or more objects from the collection by setting their foreign keys to +NULL+.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line686"></a>686       #   Objects will be in addition destroyed if they're associated with <tt>:dependent => :destroy</tt>,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line687"></a>687       #   and deleted if they're associated with <tt>:dependent => :delete_all</tt>.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line688"></a>688       # [collection=objects]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line689"></a>689       #   Replaces the collections content by deleting and adding objects as appropriate.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line690"></a>690       # [collection_singular_ids]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line691"></a>691       #   Returns an array of the associated objects' ids</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line692"></a>692       # [collection_singular_ids=ids]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line693"></a>693       #   Replace the collection with the objects identified by the primary keys in +ids+</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line694"></a>694       # [collection.clear]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line695"></a>695       #   Removes every object from the collection. This destroys the associated objects if they</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line696"></a>696       #   are associated with <tt>:dependent => :destroy</tt>, deletes them directly from the</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line697"></a>697       #   database if <tt>:dependent => :delete_all</tt>, otherwise sets their foreign keys to +NULL+.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line698"></a>698       # [collection.empty?]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line699"></a>699       #   Returns +true+ if there are no associated objects.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line700"></a>700       # [collection.size]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line701"></a>701       #   Returns the number of associated objects.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line702"></a>702       # [collection.find(...)]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line703"></a>703       #   Finds an associated object according to the same rules as ActiveRecord::Base.find.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line704"></a>704       # [collection.exists?(...)]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line705"></a>705       #   Checks whether an associated object with the given conditions exists.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line706"></a>706       #   Uses the same rules as ActiveRecord::Base.exists?.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line707"></a>707       # [collection.build(attributes = {}, ...)]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line708"></a>708       #   Returns one or more new objects of the collection type that have been instantiated</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line709"></a>709       #   with +attributes+ and linked to this object through a foreign key, but have not yet</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line710"></a>710       #   been saved. <b>Note:</b> This only works if an associated object already exists, not if</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line711"></a>711       #   it's +nil+!</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line712"></a>712       # [collection.create(attributes = {})]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line713"></a>713       #   Returns a new object of the collection type that has been instantiated</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line714"></a>714       #   with +attributes+, linked to this object through a foreign key, and that has already</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line715"></a>715       #   been saved (if it passed the validation). <b>Note:</b> This only works if an associated</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line716"></a>716       #   object already exists, not if it's +nil+!</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line717"></a>717       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line718"></a>718       # (*Note*: +collection+ is replaced with the symbol passed as the first argument, so</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line719"></a>719       # <tt>has_many :clients</tt> would add among others <tt>clients.empty?</tt>.)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line720"></a>720       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line721"></a>721       # === Example</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line722"></a>722       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line723"></a>723       # Example: A Firm class declares <tt>has_many :clients</tt>, which will add:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line724"></a>724       # * <tt>Firm#clients</tt> (similar to <tt>Clients.find :all, :conditions => ["firm_id = ?", id]</tt>)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line725"></a>725       # * <tt>Firm#clients<<</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line726"></a>726       # * <tt>Firm#clients.delete</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line727"></a>727       # * <tt>Firm#clients=</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line728"></a>728       # * <tt>Firm#client_ids</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line729"></a>729       # * <tt>Firm#client_ids=</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line730"></a>730       # * <tt>Firm#clients.clear</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line731"></a>731       # * <tt>Firm#clients.empty?</tt> (similar to <tt>firm.clients.size == 0</tt>)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line732"></a>732       # * <tt>Firm#clients.size</tt> (similar to <tt>Client.count "firm_id = #{id}"</tt>)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line733"></a>733       # * <tt>Firm#clients.find</tt> (similar to <tt>Client.find(id, :conditions => "firm_id = #{id}")</tt>)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line734"></a>734       # * <tt>Firm#clients.exists?(:name => 'ACME')</tt> (similar to <tt>Client.exists?(:name => 'ACME', :firm_id => firm.id)</tt>)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line735"></a>735       # * <tt>Firm#clients.build</tt> (similar to <tt>Client.new("firm_id" => id)</tt>)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line736"></a>736       # * <tt>Firm#clients.create</tt> (similar to <tt>c = Client.new("firm_id" => id); c.save; c</tt>)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line737"></a>737       # The declaration can also include an options hash to specialize the behavior of the association.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line738"></a>738       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line739"></a>739       # === Supported options</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line740"></a>740       # [:class_name]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line741"></a>741       #   Specify the class name of the association. Use it only if that name can't be inferred</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line742"></a>742       #   from the association name. So <tt>has_many :products</tt> will by default be linked to the Product class, but</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line743"></a>743       #   if the real class name is SpecialProduct, you'll have to specify it with this option.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line744"></a>744       # [:conditions]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line745"></a>745       #   Specify the conditions that the associated objects must meet in order to be included as a +WHERE+</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line746"></a>746       #   SQL fragment, such as <tt>price > 5 AND name LIKE 'B%'</tt>.  Record creations from the association are scoped if a hash</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line747"></a>747       #   is used.  <tt>has_many :posts, :conditions => {:published => true}</tt> will create published posts with <tt>@blog.posts.create</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line748"></a>748       #   or <tt>@blog.posts.build</tt>.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line749"></a>749       # [:order]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line750"></a>750       #   Specify the order in which the associated objects are returned as an <tt>ORDER BY</tt> SQL fragment,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line751"></a>751       #   such as <tt>last_name, first_name DESC</tt>.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line752"></a>752       # [:foreign_key]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line753"></a>753       #   Specify the foreign key used for the association. By default this is guessed to be the name</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line754"></a>754       #   of this class in lower-case and "_id" suffixed. So a Person class that makes a +has_many+ association will use "person_id"</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line755"></a>755       #   as the default <tt>:foreign_key</tt>.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line756"></a>756       # [:primary_key]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line757"></a>757       #   Specify the method that returns the primary key used for the association. By default this is +id+.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line758"></a>758       # [:dependent]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line759"></a>759       #   If set to <tt>:destroy</tt> all the associated objects are destroyed</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line760"></a>760       #   alongside this object by calling their +destroy+ method.  If set to <tt>:delete_all</tt> all associated</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line761"></a>761       #   objects are deleted *without* calling their +destroy+ method.  If set to <tt>:nullify</tt> all associated</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line762"></a>762       #   objects' foreign keys are set to +NULL+ *without* calling their +save+ callbacks. *Warning:* This option is ignored when also using</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line763"></a>763       #   the <tt>:through</tt> option.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line764"></a>764       # [:finder_sql]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line765"></a>765       #   Specify a complete SQL statement to fetch the association. This is a good way to go for complex</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line766"></a>766       #   associations that depend on multiple tables. Note: When this option is used, +find_in_collection+ is _not_ added.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line767"></a>767       # [:counter_sql]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line768"></a>768       #   Specify a complete SQL statement to fetch the size of the association. If <tt>:finder_sql</tt> is</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line769"></a>769       #   specified but not <tt>:counter_sql</tt>, <tt>:counter_sql</tt> will be generated by replacing <tt>SELECT ... FROM</tt> with <tt>SELECT COUNT(*) FROM</tt>.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line770"></a>770       # [:extend]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line771"></a>771       #   Specify a named module for extending the proxy. See "Association extensions".</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line772"></a>772       # [:include]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line773"></a>773       #   Specify second-order associations that should be eager loaded when the collection is loaded.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line774"></a>774       # [:group]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line775"></a>775       #   An attribute name by which the result should be grouped. Uses the <tt>GROUP BY</tt> SQL-clause.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line776"></a>776       # [:having]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line777"></a>777       #   Combined with +:group+ this can be used to filter the records that a <tt>GROUP BY</tt> returns. Uses the <tt>HAVING</tt> SQL-clause.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line778"></a>778       # [:limit]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line779"></a>779       #   An integer determining the limit on the number of rows that should be returned.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line780"></a>780       # [:offset]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line781"></a>781       #   An integer determining the offset from where the rows should be fetched. So at 5, it would skip the first 4 rows.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line782"></a>782       # [:select]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line783"></a>783       #   By default, this is <tt>*</tt> as in <tt>SELECT * FROM</tt>, but can be changed if you, for example, want to do a join</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line784"></a>784       #   but not include the joined columns. Do not forget to include the primary and foreign keys, otherwise it will raise an error.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line785"></a>785       # [:as]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line786"></a>786       #   Specifies a polymorphic interface (See <tt>belongs_to</tt>).</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line787"></a>787       # [:through]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line788"></a>788       #   Specifies a Join Model through which to perform the query.  Options for <tt>:class_name</tt> and <tt>:foreign_key</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line789"></a>789       #   are ignored, as the association uses the source reflection. You can only use a <tt>:through</tt> query through a <tt>belongs_to</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line790"></a>790       #   <tt>has_one</tt> or <tt>has_many</tt> association on the join model.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line791"></a>791       # [:source]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line792"></a>792       #   Specifies the source association name used by <tt>has_many :through</tt> queries.  Only use it if the name cannot be</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line793"></a>793       #   inferred from the association.  <tt>has_many :subscribers, :through => :subscriptions</tt> will look for either <tt>:subscribers</tt> or</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line794"></a>794       #   <tt>:subscriber</tt> on Subscription, unless a <tt>:source</tt> is given.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line795"></a>795       # [:source_type]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line796"></a>796       #   Specifies type of the source association used by <tt>has_many :through</tt> queries where the source</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line797"></a>797       #   association is a polymorphic +belongs_to+.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line798"></a>798       # [:uniq]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line799"></a>799       #   If true, duplicates will be omitted from the collection. Useful in conjunction with <tt>:through</tt>.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line800"></a>800       # [:readonly]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line801"></a>801       #   If true, all the associated objects are readonly through the association.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line802"></a>802       # [:validate]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line803"></a>803       #   If false, don't validate the associated objects when saving the parent object. true by default.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line804"></a>804       # [:autosave]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line805"></a>805       #   If true, always save any loaded members and destroy members marked for destruction, when saving the parent object. Off by default.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line806"></a>806       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line807"></a>807       # Option examples:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line808"></a>808       #   has_many :comments, :order => "posted_on"</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line809"></a>809       #   has_many :comments, :include => :author</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line810"></a>810       #   has_many :people, :class_name => "Person", :conditions => "deleted = 0", :order => "name"</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line811"></a>811       #   has_many :tracks, :order => "position", :dependent => :destroy</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line812"></a>812       #   has_many :comments, :dependent => :nullify</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line813"></a>813       #   has_many :tags, :as => :taggable</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line814"></a>814       #   has_many :reports, :readonly => true</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line815"></a>815       #   has_many :subscribers, :through => :subscriptions, :source => :user</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line816"></a>816       #   has_many :subscribers, :class_name => "Person", :finder_sql =></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line817"></a>817       #       'SELECT DISTINCT people.* ' +</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line818"></a>818       #       'FROM people p, post_subscriptions ps ' +</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line819"></a>819       #       'WHERE ps.post_id = #{id} AND ps.person_id = p.id ' +</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line820"></a>820       #       'ORDER BY p.first_name'</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line821"></a>821       def has_many(association_id, options = {}, &extension)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line822"></a>822         reflection = create_has_many_reflection(association_id, options, &extension)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line823"></a>823         configure_dependency_for_has_many(reflection)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line824"></a>824         add_association_callbacks(reflection.name, reflection.options)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line825"></a>825 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line826"></a>826         if options[:through]</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line827"></a>827           collection_accessor_methods(reflection, HasManyThroughAssociation)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line828"></a>828         else</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line829"></a>829           collection_accessor_methods(reflection, HasManyAssociation)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line830"></a>830         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line831"></a>831       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line832"></a>832 </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line833"></a>833       # Specifies a one-to-one association with another class. This method should only be used</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line834"></a>834       # if the other class contains the foreign key. If the current class contains the foreign key,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line835"></a>835       # then you should use +belongs_to+ instead. See also ActiveRecord::Associations::ClassMethods's overview</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line836"></a>836       # on when to use has_one and when to use belongs_to.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line837"></a>837       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line838"></a>838       # The following methods for retrieval and query of a single associated object will be added:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line839"></a>839       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line840"></a>840       # [association(force_reload = false)]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line841"></a>841       #   Returns the associated object. +nil+ is returned if none is found.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line842"></a>842       # [association=(associate)]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line843"></a>843       #   Assigns the associate object, extracts the primary key, sets it as the foreign key,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line844"></a>844       #   and saves the associate object.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line845"></a>845       # [build_association(attributes = {})]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line846"></a>846       #   Returns a new object of the associated type that has been instantiated</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line847"></a>847       #   with +attributes+ and linked to this object through a foreign key, but has not</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line848"></a>848       #   yet been saved. <b>Note:</b> This ONLY works if an association already exists.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line849"></a>849       #   It will NOT work if the association is +nil+.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line850"></a>850       # [create_association(attributes = {})]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line851"></a>851       #   Returns a new object of the associated type that has been instantiated</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line852"></a>852       #   with +attributes+, linked to this object through a foreign key, and that</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line853"></a>853       #   has already been saved (if it passed the validation).</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line854"></a>854       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line855"></a>855       # (+association+ is replaced with the symbol passed as the first argument, so</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line856"></a>856       # <tt>has_one :manager</tt> would add among others <tt>manager.nil?</tt>.)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line857"></a>857       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line858"></a>858       # === Example</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line859"></a>859       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line860"></a>860       # An Account class declares <tt>has_one :beneficiary</tt>, which will add:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line861"></a>861       # * <tt>Account#beneficiary</tt> (similar to <tt>Beneficiary.find(:first, :conditions => "account_id = #{id}")</tt>)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line862"></a>862       # * <tt>Account#beneficiary=(beneficiary)</tt> (similar to <tt>beneficiary.account_id = account.id; beneficiary.save</tt>)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line863"></a>863       # * <tt>Account#build_beneficiary</tt> (similar to <tt>Beneficiary.new("account_id" => id)</tt>)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line864"></a>864       # * <tt>Account#create_beneficiary</tt> (similar to <tt>b = Beneficiary.new("account_id" => id); b.save; b</tt>)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line865"></a>865       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line866"></a>866       # === Options</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line867"></a>867       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line868"></a>868       # The declaration can also include an options hash to specialize the behavior of the association.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line869"></a>869       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line870"></a>870       # Options are:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line871"></a>871       # [:class_name]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line872"></a>872       #   Specify the class name of the association. Use it only if that name can't be inferred</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line873"></a>873       #   from the association name. So <tt>has_one :manager</tt> will by default be linked to the Manager class, but</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line874"></a>874       #   if the real class name is Person, you'll have to specify it with this option.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line875"></a>875       # [:conditions]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line876"></a>876       #   Specify the conditions that the associated object must meet in order to be included as a +WHERE+</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line877"></a>877       #   SQL fragment, such as <tt>rank = 5</tt>.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line878"></a>878       # [:order]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line879"></a>879       #   Specify the order in which the associated objects are returned as an <tt>ORDER BY</tt> SQL fragment,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line880"></a>880       #   such as <tt>last_name, first_name DESC</tt>.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line881"></a>881       # [:dependent]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line882"></a>882       #   If set to <tt>:destroy</tt>, the associated object is destroyed when this object is. If set to</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line883"></a>883       #   <tt>:delete</tt>, the associated object is deleted *without* calling its destroy method. If set to <tt>:nullify</tt>, the associated</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line884"></a>884       #   object's foreign key is set to +NULL+. Also, association is assigned.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line885"></a>885       # [:foreign_key]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line886"></a>886       #   Specify the foreign key used for the association. By default this is guessed to be the name</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line887"></a>887       #   of this class in lower-case and "_id" suffixed. So a Person class that makes a +has_one+ association will use "person_id"</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line888"></a>888       #   as the default <tt>:foreign_key</tt>.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line889"></a>889       # [:primary_key]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line890"></a>890       #   Specify the method that returns the primary key used for the association. By default this is +id+.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line891"></a>891       # [:include]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line892"></a>892       #   Specify second-order associations that should be eager loaded when this object is loaded.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line893"></a>893       # [:as]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line894"></a>894       #   Specifies a polymorphic interface (See <tt>belongs_to</tt>).</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line895"></a>895       # [:select]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line896"></a>896       #   By default, this is <tt>*</tt> as in <tt>SELECT * FROM</tt>, but can be changed if, for example, you want to do a join</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line897"></a>897       #   but not include the joined columns. Do not forget to include the primary and foreign keys, otherwise it will raise an error.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line898"></a>898       # [:through]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line899"></a>899       #   Specifies a Join Model through which to perform the query.  Options for <tt>:class_name</tt> and <tt>:foreign_key</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line900"></a>900       #   are ignored, as the association uses the source reflection. You can only use a <tt>:through</tt> query through a </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line901"></a>901       #   <tt>has_one</tt> or <tt>belongs_to</tt> association on the join model.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line902"></a>902       # [:source]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line903"></a>903       #   Specifies the source association name used by <tt>has_one :through</tt> queries.  Only use it if the name cannot be</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line904"></a>904       #   inferred from the association.  <tt>has_one :favorite, :through => :favorites</tt> will look for a</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line905"></a>905       #   <tt>:favorite</tt> on Favorite, unless a <tt>:source</tt> is given.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line906"></a>906       # [:source_type]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line907"></a>907       #   Specifies type of the source association used by <tt>has_one :through</tt> queries where the source</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line908"></a>908       #   association is a polymorphic +belongs_to+.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line909"></a>909       # [:readonly]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line910"></a>910       #   If true, the associated object is readonly through the association.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line911"></a>911       # [:validate]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line912"></a>912       #   If false, don't validate the associated object when saving the parent object. +false+ by default.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line913"></a>913       # [:autosave]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line914"></a>914       #   If true, always save the associated object or destroy it if marked for destruction, when saving the parent object. Off by default.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line915"></a>915       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line916"></a>916       # Option examples:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line917"></a>917       #   has_one :credit_card, :dependent => :destroy  # destroys the associated credit card</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line918"></a>918       #   has_one :credit_card, :dependent => :nullify  # updates the associated records foreign key value to NULL rather than destroying it</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line919"></a>919       #   has_one :last_comment, :class_name => "Comment", :order => "posted_on"</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line920"></a>920       #   has_one :project_manager, :class_name => "Person", :conditions => "role = 'project_manager'"</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line921"></a>921       #   has_one :attachment, :as => :attachable</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line922"></a>922       #   has_one :boss, :readonly => :true</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line923"></a>923       #   has_one :club, :through => :membership</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line924"></a>924       #   has_one :primary_address, :through => :addressables, :conditions => ["addressable.primary = ?", true], :source => :addressable</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line925"></a>925       def has_one(association_id, options = {})</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line926"></a>926         if options[:through]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line927"></a>927           reflection = create_has_one_through_reflection(association_id, options)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line928"></a>928           association_accessor_methods(reflection, ActiveRecord::Associations::HasOneThroughAssociation)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line929"></a>929         else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line930"></a>930           reflection = create_has_one_reflection(association_id, options)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line931"></a>931           association_accessor_methods(reflection, HasOneAssociation)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line932"></a>932           association_constructor_method(:build,  reflection, HasOneAssociation)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line933"></a>933           association_constructor_method(:create, reflection, HasOneAssociation)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line934"></a>934           configure_dependency_for_has_one(reflection)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line935"></a>935         end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line936"></a>936       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line937"></a>937 </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line938"></a>938       # Specifies a one-to-one association with another class. This method should only be used</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line939"></a>939       # if this class contains the foreign key. If the other class contains the foreign key,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line940"></a>940       # then you should use +has_one+ instead. See also ActiveRecord::Associations::ClassMethods's overview</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line941"></a>941       # on when to use +has_one+ and when to use +belongs_to+.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line942"></a>942       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line943"></a>943       # Methods will be added for retrieval and query for a single associated object, for which</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line944"></a>944       # this object holds an id:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line945"></a>945       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line946"></a>946       # [association(force_reload = false)]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line947"></a>947       #   Returns the associated object. +nil+ is returned if none is found.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line948"></a>948       # [association=(associate)]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line949"></a>949       #   Assigns the associate object, extracts the primary key, and sets it as the foreign key.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line950"></a>950       # [build_association(attributes = {})]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line951"></a>951       #   Returns a new object of the associated type that has been instantiated</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line952"></a>952       #   with +attributes+ and linked to this object through a foreign key, but has not yet been saved.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line953"></a>953       # [create_association(attributes = {})]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line954"></a>954       #   Returns a new object of the associated type that has been instantiated</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line955"></a>955       #   with +attributes+, linked to this object through a foreign key, and that</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line956"></a>956       #   has already been saved (if it passed the validation).</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line957"></a>957       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line958"></a>958       # (+association+ is replaced with the symbol passed as the first argument, so</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line959"></a>959       # <tt>belongs_to :author</tt> would add among others <tt>author.nil?</tt>.)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line960"></a>960       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line961"></a>961       # === Example</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line962"></a>962       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line963"></a>963       # A Post class declares <tt>belongs_to :author</tt>, which will add:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line964"></a>964       # * <tt>Post#author</tt> (similar to <tt>Author.find(author_id)</tt>)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line965"></a>965       # * <tt>Post#author=(author)</tt> (similar to <tt>post.author_id = author.id</tt>)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line966"></a>966       # * <tt>Post#author?</tt> (similar to <tt>post.author == some_author</tt>)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line967"></a>967       # * <tt>Post#build_author</tt> (similar to <tt>post.author = Author.new</tt>)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line968"></a>968       # * <tt>Post#create_author</tt> (similar to <tt>post.author = Author.new; post.author.save; post.author</tt>)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line969"></a>969       # The declaration can also include an options hash to specialize the behavior of the association.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line970"></a>970       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line971"></a>971       # === Options</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line972"></a>972       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line973"></a>973       # [:class_name]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line974"></a>974       #   Specify the class name of the association. Use it only if that name can't be inferred</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line975"></a>975       #   from the association name. So <tt>has_one :author</tt> will by default be linked to the Author class, but</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line976"></a>976       #   if the real class name is Person, you'll have to specify it with this option.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line977"></a>977       # [:conditions]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line978"></a>978       #   Specify the conditions that the associated object must meet in order to be included as a +WHERE+</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line979"></a>979       #   SQL fragment, such as <tt>authorized = 1</tt>.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line980"></a>980       # [:select]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line981"></a>981       #   By default, this is <tt>*</tt> as in <tt>SELECT * FROM</tt>, but can be changed if, for example, you want to do a join</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line982"></a>982       #   but not include the joined columns. Do not forget to include the primary and foreign keys, otherwise it will raise an error.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line983"></a>983       # [:foreign_key]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line984"></a>984       #   Specify the foreign key used for the association. By default this is guessed to be the name</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line985"></a>985       #   of the association with an "_id" suffix. So a class that defines a <tt>belongs_to :person</tt> association will use</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line986"></a>986       #   "person_id" as the default <tt>:foreign_key</tt>. Similarly, <tt>belongs_to :favorite_person, :class_name => "Person"</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line987"></a>987       #   will use a foreign key of "favorite_person_id".</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line988"></a>988       # [:primary_key]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line989"></a>989       #   Specify the method that returns the primary key of associated object used for the association. By default this is id.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line990"></a>990       # [:dependent]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line991"></a>991       #   If set to <tt>:destroy</tt>, the associated object is destroyed when this object is. If set to</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line992"></a>992       #   <tt>:delete</tt>, the associated object is deleted *without* calling its destroy method. This option should not be specified when</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line993"></a>993       #   <tt>belongs_to</tt> is used in conjunction with a <tt>has_many</tt> relationship on another class because of the potential to leave</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line994"></a>994       #   orphaned records behind.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line995"></a>995       # [:counter_cache]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line996"></a>996       #   Caches the number of belonging objects on the associate class through the use of +increment_counter+</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line997"></a>997       #   and +decrement_counter+. The counter cache is incremented when an object of this class is created and decremented when it's</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line998"></a>998       #   destroyed. This requires that a column named <tt>#{table_name}_count</tt> (such as +comments_count+ for a belonging Comment class)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line999"></a>999       #   is used on the associate class (such as a Post class). You can also specify a custom counter cache column by providing</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1000"></a>1000       #   a column name instead of a +true+/+false+ value to this option (e.g., <tt>:counter_cache => :my_custom_counter</tt>.)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1001"></a>1001       #   Note: Specifying a counter cache will add it to that model's list of readonly attributes using +attr_readonly+.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1002"></a>1002       # [:include]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1003"></a>1003       #   Specify second-order associations that should be eager loaded when this object is loaded.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1004"></a>1004       # [:polymorphic]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1005"></a>1005       #   Specify this association is a polymorphic association by passing +true+.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1006"></a>1006       #   Note: If you've enabled the counter cache, then you may want to add the counter cache attribute</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1007"></a>1007       #   to the +attr_readonly+ list in the associated classes (e.g. <tt>class Post; attr_readonly :comments_count; end</tt>).</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1008"></a>1008       # [:readonly]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1009"></a>1009       #   If true, the associated object is readonly through the association.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1010"></a>1010       # [:validate]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1011"></a>1011       #   If false, don't validate the associated objects when saving the parent object. +false+ by default.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1012"></a>1012       # [:autosave]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1013"></a>1013       #   If true, always save the associated object or destroy it if marked for destruction, when saving the parent object. Off by default.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1014"></a>1014       # [:touch]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1015"></a>1015       #   If true, the associated object will be touched (the updated_at/on attributes set to now) when this record is either saved or</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1016"></a>1016       #   destroyed. If you specify a symbol, that attribute will be updated with the current time instead of the updated_at/on attribute.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1017"></a>1017       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1018"></a>1018       # Option examples:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1019"></a>1019       #   belongs_to :firm, :foreign_key => "client_of"</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1020"></a>1020       #   belongs_to :person, :primary_key => "name", :foreign_key => "person_name"</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1021"></a>1021       #   belongs_to :author, :class_name => "Person", :foreign_key => "author_id"</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1022"></a>1022       #   belongs_to :valid_coupon, :class_name => "Coupon", :foreign_key => "coupon_id",</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1023"></a>1023       #              :conditions => 'discounts > #{payments_count}'</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1024"></a>1024       #   belongs_to :attachable, :polymorphic => true</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1025"></a>1025       #   belongs_to :project, :readonly => true</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1026"></a>1026       #   belongs_to :post, :counter_cache => true</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1027"></a>1027       #   belongs_to :company, :touch => true</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1028"></a>1028       #   belongs_to :company, :touch => :employees_last_updated_at</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1029"></a>1029       def belongs_to(association_id, options = {})</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1030"></a>1030         reflection = create_belongs_to_reflection(association_id, options)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1031"></a>1031 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1032"></a>1032         if reflection.options[:polymorphic]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1033"></a>1033           association_accessor_methods(reflection, BelongsToPolymorphicAssociation)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1034"></a>1034         else</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1035"></a>1035           association_accessor_methods(reflection, BelongsToAssociation)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1036"></a>1036           association_constructor_method(:build,  reflection, BelongsToAssociation)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1037"></a>1037           association_constructor_method(:create, reflection, BelongsToAssociation)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1038"></a>1038         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1039"></a>1039 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1040"></a>1040         add_counter_cache_callbacks(reflection)          if options[:counter_cache]</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1041"></a>1041         add_touch_callbacks(reflection, options[:touch]) if options[:touch]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1042"></a>1042 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1043"></a>1043         configure_dependency_for_belongs_to(reflection)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1044"></a>1044       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1045"></a>1045 </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1046"></a>1046       # Specifies a many-to-many relationship with another class. This associates two classes via an</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1047"></a>1047       # intermediate join table.  Unless the join table is explicitly specified as an option, it is</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1048"></a>1048       # guessed using the lexical order of the class names. So a join between Developer and Project</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1049"></a>1049       # will give the default join table name of "developers_projects" because "D" outranks "P".  Note that this precedence</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1050"></a>1050       # is calculated using the <tt><</tt> operator for String.  This means that if the strings are of different lengths,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1051"></a>1051       # and the strings are equal when compared up to the shortest length, then the longer string is considered of higher</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1052"></a>1052       # lexical precedence than the shorter one.  For example, one would expect the tables "paper_boxes" and "papers"</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1053"></a>1053       # to generate a join table name of "papers_paper_boxes" because of the length of the name "paper_boxes",</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1054"></a>1054       # but it in fact generates a join table name of "paper_boxes_papers".  Be aware of this caveat, and use the</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1055"></a>1055       # custom <tt>:join_table</tt> option if you need to.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1056"></a>1056       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1057"></a>1057       # The join table should not have a primary key or a model associated with it. You must manually generate the</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1058"></a>1058       # join table with a migration such as this:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1059"></a>1059       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1060"></a>1060       #   class CreateDevelopersProjectsJoinTable < ActiveRecord::Migration</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1061"></a>1061       #     def self.up</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1062"></a>1062       #       create_table :developers_projects, :id => false do |t|</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1063"></a>1063       #         t.integer :developer_id</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1064"></a>1064       #         t.integer :project_id</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1065"></a>1065       #       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1066"></a>1066       #     end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1067"></a>1067       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1068"></a>1068       #     def self.down</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1069"></a>1069       #       drop_table :developers_projects</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1070"></a>1070       #     end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1071"></a>1071       #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1072"></a>1072       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1073"></a>1073       # Deprecated: Any additional fields added to the join table will be placed as attributes when pulling records out through</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1074"></a>1074       # +has_and_belongs_to_many+ associations. Records returned from join tables with additional attributes will be marked as</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1075"></a>1075       # readonly (because we can't save changes to the additional attributes). It's strongly recommended that you upgrade any</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1076"></a>1076       # associations with attributes to a real join model (see introduction).</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1077"></a>1077       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1078"></a>1078       # Adds the following methods for retrieval and query:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1079"></a>1079       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1080"></a>1080       # [collection(force_reload = false)]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1081"></a>1081       #   Returns an array of all the associated objects.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1082"></a>1082       #   An empty array is returned if none are found.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1083"></a>1083       # [collection<<(object, ...)]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1084"></a>1084       #   Adds one or more objects to the collection by creating associations in the join table</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1085"></a>1085       #   (<tt>collection.push</tt> and <tt>collection.concat</tt> are aliases to this method).</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1086"></a>1086       # [collection.delete(object, ...)]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1087"></a>1087       #   Removes one or more objects from the collection by removing their associations from the join table.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1088"></a>1088       #   This does not destroy the objects.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1089"></a>1089       # [collection=objects]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1090"></a>1090       #   Replaces the collection's content by deleting and adding objects as appropriate.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1091"></a>1091       # [collection_singular_ids]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1092"></a>1092       #   Returns an array of the associated objects' ids.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1093"></a>1093       # [collection_singular_ids=ids]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1094"></a>1094       #   Replace the collection by the objects identified by the primary keys in +ids+.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1095"></a>1095       # [collection.clear]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1096"></a>1096       #   Removes every object from the collection. This does not destroy the objects.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1097"></a>1097       # [collection.empty?]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1098"></a>1098       #   Returns +true+ if there are no associated objects.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1099"></a>1099       # [collection.size]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1100"></a>1100       #   Returns the number of associated objects.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1101"></a>1101       # [collection.find(id)]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1102"></a>1102       #   Finds an associated object responding to the +id+ and that</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1103"></a>1103       #   meets the condition that it has to be associated with this object.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1104"></a>1104       #   Uses the same rules as ActiveRecord::Base.find.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1105"></a>1105       # [collection.exists?(...)]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1106"></a>1106       #   Checks whether an associated object with the given conditions exists.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1107"></a>1107       #   Uses the same rules as ActiveRecord::Base.exists?.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1108"></a>1108       # [collection.build(attributes = {})]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1109"></a>1109       #   Returns a new object of the collection type that has been instantiated</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1110"></a>1110       #   with +attributes+ and linked to this object through the join table, but has not yet been saved.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1111"></a>1111       # [collection.create(attributes = {})]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1112"></a>1112       #   Returns a new object of the collection type that has been instantiated</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1113"></a>1113       #   with +attributes+, linked to this object through the join table, and that has already been saved (if it passed the validation).</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1114"></a>1114       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1115"></a>1115       # (+collection+ is replaced with the symbol passed as the first argument, so</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1116"></a>1116       # <tt>has_and_belongs_to_many :categories</tt> would add among others <tt>categories.empty?</tt>.)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1117"></a>1117       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1118"></a>1118       # === Example</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1119"></a>1119       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1120"></a>1120       # A Developer class declares <tt>has_and_belongs_to_many :projects</tt>, which will add:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1121"></a>1121       # * <tt>Developer#projects</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1122"></a>1122       # * <tt>Developer#projects<<</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1123"></a>1123       # * <tt>Developer#projects.delete</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1124"></a>1124       # * <tt>Developer#projects=</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1125"></a>1125       # * <tt>Developer#project_ids</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1126"></a>1126       # * <tt>Developer#project_ids=</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1127"></a>1127       # * <tt>Developer#projects.clear</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1128"></a>1128       # * <tt>Developer#projects.empty?</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1129"></a>1129       # * <tt>Developer#projects.size</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1130"></a>1130       # * <tt>Developer#projects.find(id)</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1131"></a>1131       # * <tt>Developer#clients.exists?(...)</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1132"></a>1132       # * <tt>Developer#projects.build</tt> (similar to <tt>Project.new("project_id" => id)</tt>)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1133"></a>1133       # * <tt>Developer#projects.create</tt> (similar to <tt>c = Project.new("project_id" => id); c.save; c</tt>)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1134"></a>1134       # The declaration may include an options hash to specialize the behavior of the association.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1135"></a>1135       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1136"></a>1136       # === Options</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1137"></a>1137       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1138"></a>1138       # [:class_name]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1139"></a>1139       #   Specify the class name of the association. Use it only if that name can't be inferred</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1140"></a>1140       #   from the association name. So <tt>has_and_belongs_to_many :projects</tt> will by default be linked to the</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1141"></a>1141       #   Project class, but if the real class name is SuperProject, you'll have to specify it with this option.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1142"></a>1142       # [:join_table]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1143"></a>1143       #   Specify the name of the join table if the default based on lexical order isn't what you want.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1144"></a>1144       #   <b>WARNING:</b> If you're overwriting the table name of either class, the +table_name+ method</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1145"></a>1145       #   MUST be declared underneath any +has_and_belongs_to_many+ declaration in order to work.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1146"></a>1146       # [:foreign_key]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1147"></a>1147       #   Specify the foreign key used for the association. By default this is guessed to be the name</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1148"></a>1148       #   of this class in lower-case and "_id" suffixed. So a Person class that makes a +has_and_belongs_to_many+ association</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1149"></a>1149       #   to Project will use "person_id" as the default <tt>:foreign_key</tt>.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1150"></a>1150       # [:association_foreign_key]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1151"></a>1151       #   Specify the foreign key used for the association on the receiving side of the association.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1152"></a>1152       #   By default this is guessed to be the name of the associated class in lower-case and "_id" suffixed.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1153"></a>1153       #   So if a Person class makes a +has_and_belongs_to_many+ association to Project,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1154"></a>1154       #   the association will use "project_id" as the default <tt>:association_foreign_key</tt>.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1155"></a>1155       # [:conditions]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1156"></a>1156       #   Specify the conditions that the associated object must meet in order to be included as a +WHERE+</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1157"></a>1157       #   SQL fragment, such as <tt>authorized = 1</tt>.  Record creations from the association are scoped if a hash is used.  </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1158"></a>1158       #   <tt>has_many :posts, :conditions => {:published => true}</tt> will create published posts with <tt>@blog.posts.create</tt> </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1159"></a>1159       #   or <tt>@blog.posts.build</tt>.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1160"></a>1160       # [:order]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1161"></a>1161       #   Specify the order in which the associated objects are returned as an <tt>ORDER BY</tt> SQL fragment,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1162"></a>1162       #   such as <tt>last_name, first_name DESC</tt></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1163"></a>1163       # [:uniq]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1164"></a>1164       #   If true, duplicate associated objects will be ignored by accessors and query methods.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1165"></a>1165       # [:finder_sql]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1166"></a>1166       #   Overwrite the default generated SQL statement used to fetch the association with a manual statement</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1167"></a>1167       # [:counter_sql]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1168"></a>1168       #   Specify a complete SQL statement to fetch the size of the association. If <tt>:finder_sql</tt> is</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1169"></a>1169       #   specified but not <tt>:counter_sql</tt>, <tt>:counter_sql</tt> will be generated by replacing <tt>SELECT ... FROM</tt> with <tt>SELECT COUNT(*) FROM</tt>.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1170"></a>1170       # [:delete_sql]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1171"></a>1171       #   Overwrite the default generated SQL statement used to remove links between the associated</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1172"></a>1172       #   classes with a manual statement.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1173"></a>1173       # [:insert_sql]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1174"></a>1174       #   Overwrite the default generated SQL statement used to add links between the associated classes</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1175"></a>1175       #   with a manual statement.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1176"></a>1176       # [:extend]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1177"></a>1177       #   Anonymous module for extending the proxy, see "Association extensions".</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1178"></a>1178       # [:include]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1179"></a>1179       #   Specify second-order associations that should be eager loaded when the collection is loaded.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1180"></a>1180       # [:group]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1181"></a>1181       #   An attribute name by which the result should be grouped. Uses the <tt>GROUP BY</tt> SQL-clause.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1182"></a>1182       # [:having]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1183"></a>1183       #   Combined with +:group+ this can be used to filter the records that a <tt>GROUP BY</tt> returns. Uses the <tt>HAVING</tt> SQL-clause.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1184"></a>1184       # [:limit]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1185"></a>1185       #   An integer determining the limit on the number of rows that should be returned.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1186"></a>1186       # [:offset]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1187"></a>1187       #   An integer determining the offset from where the rows should be fetched. So at 5, it would skip the first 4 rows.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1188"></a>1188       # [:select]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1189"></a>1189       #   By default, this is <tt>*</tt> as in <tt>SELECT * FROM</tt>, but can be changed if, for example, you want to do a join</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1190"></a>1190       #   but not include the joined columns. Do not forget to include the primary and foreign keys, otherwise it will raise an error.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1191"></a>1191       # [:readonly]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1192"></a>1192       #   If true, all the associated objects are readonly through the association.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1193"></a>1193       # [:validate]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1194"></a>1194       #   If false, don't validate the associated objects when saving the parent object. +true+ by default.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1195"></a>1195       # [:autosave]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1196"></a>1196       #   If true, always save any loaded members and destroy members marked for destruction, when saving the parent object. Off by default.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1197"></a>1197       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1198"></a>1198       # Option examples:</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1199"></a>1199       #   has_and_belongs_to_many :projects</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1200"></a>1200       #   has_and_belongs_to_many :projects, :include => [ :milestones, :manager ]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1201"></a>1201       #   has_and_belongs_to_many :nations, :class_name => "Country"</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1202"></a>1202       #   has_and_belongs_to_many :categories, :join_table => "prods_cats"</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1203"></a>1203       #   has_and_belongs_to_many :categories, :readonly => true</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1204"></a>1204       #   has_and_belongs_to_many :active_projects, :join_table => 'developers_projects', :delete_sql =></pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1205"></a>1205       #   'DELETE FROM developers_projects WHERE active=1 AND developer_id = #{id} AND project_id = #{record.id}'</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1206"></a>1206       def has_and_belongs_to_many(association_id, options = {}, &extension)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1207"></a>1207         reflection = create_has_and_belongs_to_many_reflection(association_id, options, &extension)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1208"></a>1208         collection_accessor_methods(reflection, HasAndBelongsToManyAssociation)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1209"></a>1209 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1210"></a>1210         # Don't use a before_destroy callback since users' before_destroy</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1211"></a>1211         # callbacks will be executed after the association is wiped out.</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1212"></a>1212         old_method = "destroy_without_habtm_shim_for_#{reflection.name}"</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1213"></a>1213         class_eval <<-end_eval unless method_defined?(old_method)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1214"></a>1214           alias_method :#{old_method}, :destroy_without_callbacks  # alias_method :destroy_without_habtm_shim_for_posts, :destroy_without_callbacks</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1215"></a>1215           def destroy_without_callbacks                            # def destroy_without_callbacks</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1216"></a>1216             #{reflection.name}.clear                               #   posts.clear</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1217"></a>1217             #{old_method}                                          #   destroy_without_habtm_shim_for_posts</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1218"></a>1218           end                                                      # end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1219"></a>1219         end_eval</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1220"></a>1220 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1221"></a>1221         add_association_callbacks(reflection.name, options)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1222"></a>1222       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1223"></a>1223 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1224"></a>1224       private</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1225"></a>1225         # Generates a join table name from two provided table names.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1226"></a>1226         # The names in the join table namesme end up in lexicographic order.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1227"></a>1227         #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1228"></a>1228         #   join_table_name("members", "clubs")         # => "clubs_members"</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1229"></a>1229         #   join_table_name("members", "special_clubs") # => "members_special_clubs"</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1230"></a>1230         def join_table_name(first_table_name, second_table_name)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1231"></a>1231           if first_table_name < second_table_name</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1232"></a>1232             join_table = "#{first_table_name}_#{second_table_name}"</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1233"></a>1233           else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1234"></a>1234             join_table = "#{second_table_name}_#{first_table_name}"</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1235"></a>1235           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1236"></a>1236 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1237"></a>1237           table_name_prefix + join_table + table_name_suffix</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1238"></a>1238         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1239"></a>1239 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1240"></a>1240         def association_accessor_methods(reflection, association_proxy_class)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1241"></a>1241           define_method(reflection.name) do |*params|</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1242"></a>1242             force_reload = params.first unless params.empty?</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1243"></a>1243             association = association_instance_get(reflection.name)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1244"></a>1244 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1245"></a>1245             if association.nil? || force_reload</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1246"></a>1246               association = association_proxy_class.new(self, reflection)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1247"></a>1247               retval = association.reload</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1248"></a>1248               if retval.nil? and association_proxy_class == BelongsToAssociation</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1249"></a>1249                 association_instance_set(reflection.name, nil)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1250"></a>1250                 return nil</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1251"></a>1251               end</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1252"></a>1252               association_instance_set(reflection.name, association)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1253"></a>1253             end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1254"></a>1254 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1255"></a>1255             association.target.nil? ? nil : association</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1256"></a>1256           end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1257"></a>1257 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1258"></a>1258           define_method("loaded_#{reflection.name}?") do</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1259"></a>1259             association = association_instance_get(reflection.name)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1260"></a>1260             association && association.loaded?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1261"></a>1261           end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1262"></a>1262 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1263"></a>1263           define_method("#{reflection.name}=") do |new_value|</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1264"></a>1264             association = association_instance_get(reflection.name)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1265"></a>1265 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1266"></a>1266             if association.nil? || association.target != new_value</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1267"></a>1267               association = association_proxy_class.new(self, reflection)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1268"></a>1268             end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1269"></a>1269 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1270"></a>1270             if association_proxy_class == HasOneThroughAssociation</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1271"></a>1271               association.create_through_record(new_value)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1272"></a>1272               if new_record?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1273"></a>1273                 association_instance_set(reflection.name, new_value.nil? ? nil : association)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1274"></a>1274               else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1275"></a>1275                 self.send(reflection.name, new_value)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1276"></a>1276               end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1277"></a>1277             else</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1278"></a>1278               association.replace(new_value)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1279"></a>1279               association_instance_set(reflection.name, new_value.nil? ? nil : association)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1280"></a>1280             end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1281"></a>1281           end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1282"></a>1282 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1283"></a>1283           define_method("set_#{reflection.name}_target") do |target|</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1284"></a>1284             return if target.nil? and association_proxy_class == BelongsToAssociation</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1285"></a>1285             association = association_proxy_class.new(self, reflection)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1286"></a>1286             association.target = target</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1287"></a>1287             association_instance_set(reflection.name, association)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1288"></a>1288           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1289"></a>1289         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1290"></a>1290 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1291"></a>1291         def collection_reader_method(reflection, association_proxy_class)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1292"></a>1292           define_method(reflection.name) do |*params|</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1293"></a>1293             force_reload = params.first unless params.empty?</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1294"></a>1294             association = association_instance_get(reflection.name)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1295"></a>1295 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1296"></a>1296             unless association</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1297"></a>1297               association = association_proxy_class.new(self, reflection)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1298"></a>1298               association_instance_set(reflection.name, association)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1299"></a>1299             end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1300"></a>1300 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1301"></a>1301             association.reload if force_reload</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1302"></a>1302 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1303"></a>1303             association</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1304"></a>1304           end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1305"></a>1305 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1306"></a>1306           define_method("#{reflection.name.to_s.singularize}_ids") do</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1307"></a>1307             if send(reflection.name).loaded? || reflection.options[:finder_sql]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1308"></a>1308               send(reflection.name).map(&:id)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1309"></a>1309             else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1310"></a>1310               send(reflection.name).all(:select => "#{reflection.quoted_table_name}.#{reflection.klass.primary_key}").map(&:id)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1311"></a>1311             end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1312"></a>1312           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1313"></a>1313         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1314"></a>1314 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1315"></a>1315         def collection_accessor_methods(reflection, association_proxy_class, writer = true)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1316"></a>1316           collection_reader_method(reflection, association_proxy_class)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1317"></a>1317 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1318"></a>1318           if writer</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1319"></a>1319             define_method("#{reflection.name}=") do |new_value|</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1320"></a>1320               # Loads proxy class instance (defined in collection_reader_method) if not already loaded</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1321"></a>1321               association = send(reflection.name)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1322"></a>1322               association.replace(new_value)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1323"></a>1323               association</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1324"></a>1324             end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1325"></a>1325 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1326"></a>1326             define_method("#{reflection.name.to_s.singularize}_ids=") do |new_value|</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1327"></a>1327               ids = (new_value || []).reject { |nid| nid.blank? }</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1328"></a>1328               send("#{reflection.name}=", reflection.klass.find(ids))</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1329"></a>1329             end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1330"></a>1330           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1331"></a>1331         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1332"></a>1332 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1333"></a>1333         def association_constructor_method(constructor, reflection, association_proxy_class)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1334"></a>1334           define_method("#{constructor}_#{reflection.name}") do |*params|</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1335"></a>1335             attributees      = params.first unless params.empty?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1336"></a>1336             replace_existing = params[1].nil? ? true : params[1]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1337"></a>1337             association      = association_instance_get(reflection.name)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1338"></a>1338 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1339"></a>1339             unless association</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1340"></a>1340               association = association_proxy_class.new(self, reflection)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1341"></a>1341               association_instance_set(reflection.name, association)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1342"></a>1342             end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1343"></a>1343 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1344"></a>1344             if association_proxy_class == HasOneAssociation</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1345"></a>1345               association.send(constructor, attributees, replace_existing)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1346"></a>1346             else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1347"></a>1347               association.send(constructor, attributees)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1348"></a>1348             end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1349"></a>1349           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1350"></a>1350         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1351"></a>1351 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1352"></a>1352         def add_counter_cache_callbacks(reflection)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1353"></a>1353           cache_column = reflection.counter_cache_column</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1354"></a>1354 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1355"></a>1355           method_name = "belongs_to_counter_cache_after_create_for_#{reflection.name}".to_sym</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1356"></a>1356           define_method(method_name) do</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1357"></a>1357             association = send(reflection.name)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1358"></a>1358             association.class.increment_counter(cache_column, association.id) unless association.nil?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1359"></a>1359           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1360"></a>1360           after_create(method_name)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1361"></a>1361 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1362"></a>1362           method_name = "belongs_to_counter_cache_before_destroy_for_#{reflection.name}".to_sym</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1363"></a>1363           define_method(method_name) do</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1364"></a>1364             association = send(reflection.name)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1365"></a>1365             association.class.decrement_counter(cache_column, association.id) unless association.nil?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1366"></a>1366           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1367"></a>1367           before_destroy(method_name)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1368"></a>1368 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1369"></a>1369           module_eval(</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1370"></a>1370             "#{reflection.class_name}.send(:attr_readonly,\"#{cache_column}\".intern) if defined?(#{reflection.class_name}) && #{reflection.class_name}.respond_to?(:attr_readonly)"</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1371"></a>1371           )</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1372"></a>1372         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1373"></a>1373         </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1374"></a>1374         def add_touch_callbacks(reflection, touch_attribute)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1375"></a>1375           method_name = "belongs_to_touch_after_save_or_destroy_for_#{reflection.name}".to_sym</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1376"></a>1376           define_method(method_name) do</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1377"></a>1377             association = send(reflection.name)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1378"></a>1378             </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1379"></a>1379             if touch_attribute == true</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1380"></a>1380               association.touch unless association.nil?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1381"></a>1381             else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1382"></a>1382               association.touch(touch_attribute) unless association.nil?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1383"></a>1383             end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1384"></a>1384           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1385"></a>1385           after_save(method_name)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1386"></a>1386           after_destroy(method_name)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1387"></a>1387         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1388"></a>1388 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1389"></a>1389         def find_with_associations(options = {})</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1390"></a>1390           catch :invalid_query do</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1391"></a>1391             join_dependency = JoinDependency.new(self, merge_includes(scope(:find, :include), options[:include]), options[:joins])</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1392"></a>1392             rows = select_all_rows(options, join_dependency)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1393"></a>1393             return join_dependency.instantiate(rows)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1394"></a>1394           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1395"></a>1395           []</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1396"></a>1396         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1397"></a>1397 </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1398"></a>1398         # Creates before_destroy callback methods that nullify, delete or destroy</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1399"></a>1399         # has_many associated objects, according to the defined :dependent rule.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1400"></a>1400         #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1401"></a>1401         # See HasManyAssociation#delete_records.  Dependent associations</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1402"></a>1402         # delete children, otherwise foreign key is set to NULL.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1403"></a>1403         #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1404"></a>1404         # The +extra_conditions+ parameter, which is not used within the main</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1405"></a>1405         # Active Record codebase, is meant to allow plugins to define extra</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1406"></a>1406         # finder conditions.</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1407"></a>1407         def configure_dependency_for_has_many(reflection, extra_conditions = nil)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1408"></a>1408           if reflection.options.include?(:dependent)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1409"></a>1409             # Add polymorphic type if the :as option is present</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1410"></a>1410             dependent_conditions = []</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1411"></a>1411             dependent_conditions << "#{reflection.primary_key_name} = \#{record.quoted_id}"</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1412"></a>1412             dependent_conditions << "#{reflection.options[:as]}_type = '#{base_class.name}'" if reflection.options[:as]</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1413"></a>1413             dependent_conditions << sanitize_sql(reflection.options[:conditions], reflection.quoted_table_name) if reflection.options[:conditions]</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1414"></a>1414             dependent_conditions << extra_conditions if extra_conditions</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1415"></a>1415             dependent_conditions = dependent_conditions.collect {|where| "(#{where})" }.join(" AND ")</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1416"></a>1416             dependent_conditions = dependent_conditions.gsub('@', '\@')</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1417"></a>1417             case reflection.options[:dependent]</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1418"></a>1418               when :destroy</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1419"></a>1419                 method_name = "has_many_dependent_destroy_for_#{reflection.name}".to_sym</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1420"></a>1420                 define_method(method_name) do</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1421"></a>1421                   send(reflection.name).each { |o| o.destroy }</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1422"></a>1422                 end</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1423"></a>1423                 before_destroy method_name</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1424"></a>1424               when :delete_all</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1425"></a>1425                 module_eval %Q{</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1426"></a>1426                   before_destroy do |record|                  # before_destroy do |record|</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1427"></a>1427                     delete_all_has_many_dependencies(record,  #   delete_all_has_many_dependencies(record,</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1428"></a>1428                       "#{reflection.name}",                   #     "posts",</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1429"></a>1429                       #{reflection.class_name},               #     Post,</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1430"></a>1430                       %@#{dependent_conditions}@)             #     %@...@) # this is a string literal like %(...)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1431"></a>1431                   end                                         # end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1432"></a>1432                 }</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1433"></a>1433               when :nullify</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1434"></a>1434                 module_eval %Q{</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1435"></a>1435                   before_destroy do |record|                  # before_destroy do |record|</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1436"></a>1436                     nullify_has_many_dependencies(record,     #   nullify_has_many_dependencies(record,</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1437"></a>1437                       "#{reflection.name}",                   #     "posts",</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1438"></a>1438                       #{reflection.class_name},               #     Post,</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1439"></a>1439                       "#{reflection.primary_key_name}",       #     "user_id",</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1440"></a>1440                       %@#{dependent_conditions}@)             #     %@...@) # this is a string literal like %(...)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1441"></a>1441                   end                                         # end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1442"></a>1442                 }</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1443"></a>1443               else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1444"></a>1444                 raise ArgumentError, "The :dependent option expects either :destroy, :delete_all, or :nullify (#{reflection.options[:dependent].inspect})"</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1445"></a>1445             end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1446"></a>1446           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1447"></a>1447         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1448"></a>1448 </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1449"></a>1449         # Creates before_destroy callback methods that nullify, delete or destroy</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1450"></a>1450         # has_one associated objects, according to the defined :dependent rule.</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1451"></a>1451         def configure_dependency_for_has_one(reflection)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1452"></a>1452           if reflection.options.include?(:dependent)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1453"></a>1453             case reflection.options[:dependent]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1454"></a>1454               when :destroy</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1455"></a>1455                 method_name = "has_one_dependent_destroy_for_#{reflection.name}".to_sym</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1456"></a>1456                 define_method(method_name) do</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1457"></a>1457                   association = send(reflection.name)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1458"></a>1458                   association.destroy unless association.nil?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1459"></a>1459                 end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1460"></a>1460                 before_destroy method_name</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1461"></a>1461               when :delete</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1462"></a>1462                 method_name = "has_one_dependent_delete_for_#{reflection.name}".to_sym</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1463"></a>1463                 define_method(method_name) do</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1464"></a>1464                   # Retrieve the associated object and delete it. The retrieval</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1465"></a>1465                   # is necessary because there may be multiple associated objects</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1466"></a>1466                   # with foreign keys pointing to this object, and we only want</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1467"></a>1467                   # to delete the correct one, not all of them.</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1468"></a>1468                   association = send(reflection.name)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1469"></a>1469                   association.delete unless association.nil?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1470"></a>1470                 end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1471"></a>1471                 before_destroy method_name</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1472"></a>1472               when :nullify</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1473"></a>1473                 method_name = "has_one_dependent_nullify_for_#{reflection.name}".to_sym</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1474"></a>1474                 define_method(method_name) do</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1475"></a>1475                   association = send(reflection.name)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1476"></a>1476                   association.update_attribute(reflection.primary_key_name, nil) unless association.nil?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1477"></a>1477                 end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1478"></a>1478                 before_destroy method_name</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1479"></a>1479               else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1480"></a>1480                 raise ArgumentError, "The :dependent option expects either :destroy, :delete or :nullify (#{reflection.options[:dependent].inspect})"</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1481"></a>1481             end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1482"></a>1482           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1483"></a>1483         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1484"></a>1484 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1485"></a>1485         def configure_dependency_for_belongs_to(reflection)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1486"></a>1486           if reflection.options.include?(:dependent)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1487"></a>1487             case reflection.options[:dependent]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1488"></a>1488               when :destroy</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1489"></a>1489                 method_name = "belongs_to_dependent_destroy_for_#{reflection.name}".to_sym</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1490"></a>1490                 define_method(method_name) do</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1491"></a>1491                   association = send(reflection.name)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1492"></a>1492                   association.destroy unless association.nil?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1493"></a>1493                 end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1494"></a>1494                 after_destroy method_name</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1495"></a>1495               when :delete</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1496"></a>1496                 method_name = "belongs_to_dependent_delete_for_#{reflection.name}".to_sym</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1497"></a>1497                 define_method(method_name) do</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1498"></a>1498                   association = send(reflection.name)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1499"></a>1499                   association.delete unless association.nil?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1500"></a>1500                 end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1501"></a>1501                 after_destroy method_name</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1502"></a>1502               else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1503"></a>1503                 raise ArgumentError, "The :dependent option expects either :destroy or :delete (#{reflection.options[:dependent].inspect})"</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1504"></a>1504             end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1505"></a>1505           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1506"></a>1506         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1507"></a>1507 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1508"></a>1508         def delete_all_has_many_dependencies(record, reflection_name, association_class, dependent_conditions)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1509"></a>1509           association_class.delete_all(dependent_conditions)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1510"></a>1510         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1511"></a>1511 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1512"></a>1512         def nullify_has_many_dependencies(record, reflection_name, association_class, primary_key_name, dependent_conditions)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1513"></a>1513           association_class.update_all("#{primary_key_name} = NULL", dependent_conditions)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1514"></a>1514         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1515"></a>1515 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1516"></a>1516         mattr_accessor :valid_keys_for_has_many_association</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1517"></a>1517         @@valid_keys_for_has_many_association = [</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1518"></a>1518           :class_name, :table_name, :foreign_key, :primary_key,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1519"></a>1519           :dependent,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1520"></a>1520           :select, :conditions, :include, :order, :group, :having, :limit, :offset,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1521"></a>1521           :as, :through, :source, :source_type,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1522"></a>1522           :uniq,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1523"></a>1523           :finder_sql, :counter_sql,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1524"></a>1524           :before_add, :after_add, :before_remove, :after_remove,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1525"></a>1525           :extend, :readonly,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1526"></a>1526           :validate</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1527"></a>1527         ]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1528"></a>1528 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1529"></a>1529         def create_has_many_reflection(association_id, options, &extension)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1530"></a>1530           options.assert_valid_keys(valid_keys_for_has_many_association)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1531"></a>1531           options[:extend] = create_extension_modules(association_id, extension, options[:extend])</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1532"></a>1532 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1533"></a>1533           create_reflection(:has_many, association_id, options, self)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1534"></a>1534         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1535"></a>1535 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1536"></a>1536         mattr_accessor :valid_keys_for_has_one_association</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1537"></a>1537         @@valid_keys_for_has_one_association = [</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1538"></a>1538           :class_name, :foreign_key, :remote, :select, :conditions, :order,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1539"></a>1539           :include, :dependent, :counter_cache, :extend, :as, :readonly,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1540"></a>1540           :validate, :primary_key</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1541"></a>1541         ]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1542"></a>1542 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1543"></a>1543         def create_has_one_reflection(association_id, options)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1544"></a>1544           options.assert_valid_keys(valid_keys_for_has_one_association)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1545"></a>1545           create_reflection(:has_one, association_id, options, self)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1546"></a>1546         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1547"></a>1547 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1548"></a>1548         def create_has_one_through_reflection(association_id, options)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1549"></a>1549           options.assert_valid_keys(</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1550"></a>1550             :class_name, :foreign_key, :remote, :select, :conditions, :order, :include, :dependent, :counter_cache, :extend, :as, :through, :source, :source_type, :validate</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1551"></a>1551           )</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1552"></a>1552           create_reflection(:has_one, association_id, options, self)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1553"></a>1553         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1554"></a>1554 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1555"></a>1555         mattr_accessor :valid_keys_for_belongs_to_association</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1556"></a>1556         @@valid_keys_for_belongs_to_association = [</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1557"></a>1557           :class_name, :primary_key, :foreign_key, :foreign_type, :remote, :select, :conditions,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1558"></a>1558           :include, :dependent, :counter_cache, :extend, :polymorphic, :readonly,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1559"></a>1559           :validate, :touch</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1560"></a>1560         ]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1561"></a>1561 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1562"></a>1562         def create_belongs_to_reflection(association_id, options)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1563"></a>1563           options.assert_valid_keys(valid_keys_for_belongs_to_association)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1564"></a>1564           reflection = create_reflection(:belongs_to, association_id, options, self)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1565"></a>1565 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1566"></a>1566           if options[:polymorphic]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1567"></a>1567             reflection.options[:foreign_type] ||= reflection.class_name.underscore + "_type"</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1568"></a>1568           end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1569"></a>1569 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1570"></a>1570           reflection</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1571"></a>1571         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1572"></a>1572 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1573"></a>1573         mattr_accessor :valid_keys_for_has_and_belongs_to_many_association</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1574"></a>1574         @@valid_keys_for_has_and_belongs_to_many_association = [</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1575"></a>1575           :class_name, :table_name, :join_table, :foreign_key, :association_foreign_key,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1576"></a>1576           :select, :conditions, :include, :order, :group, :having, :limit, :offset,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1577"></a>1577           :uniq,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1578"></a>1578           :finder_sql, :counter_sql, :delete_sql, :insert_sql,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1579"></a>1579           :before_add, :after_add, :before_remove, :after_remove,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1580"></a>1580           :extend, :readonly,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1581"></a>1581           :validate</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1582"></a>1582         ]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1583"></a>1583 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1584"></a>1584         def create_has_and_belongs_to_many_reflection(association_id, options, &extension)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1585"></a>1585           options.assert_valid_keys(valid_keys_for_has_and_belongs_to_many_association)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1586"></a>1586 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1587"></a>1587           options[:extend] = create_extension_modules(association_id, extension, options[:extend])</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1588"></a>1588 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1589"></a>1589           reflection = create_reflection(:has_and_belongs_to_many, association_id, options, self)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1590"></a>1590           </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1591"></a>1591           if reflection.association_foreign_key == reflection.primary_key_name</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1592"></a>1592             raise HasAndBelongsToManyAssociationForeignKeyNeeded.new(reflection)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1593"></a>1593           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1594"></a>1594 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1595"></a>1595           reflection.options[:join_table] ||= join_table_name(undecorated_table_name(self.to_s), undecorated_table_name(reflection.class_name))</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1596"></a>1596 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1597"></a>1597           reflection</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1598"></a>1598         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1599"></a>1599 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1600"></a>1600         def reflect_on_included_associations(associations)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1601"></a>1601           [ associations ].flatten.collect { |association| reflect_on_association(association.to_s.intern) }</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1602"></a>1602         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1603"></a>1603 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1604"></a>1604         def guard_against_unlimitable_reflections(reflections, options)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1605"></a>1605           if (options[:offset] || options[:limit]) && !using_limitable_reflections?(reflections)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1606"></a>1606             raise(</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1607"></a>1607               ConfigurationError,</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1608"></a>1608               "You can not use offset and limit together with has_many or has_and_belongs_to_many associations"</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1609"></a>1609             )</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1610"></a>1610           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1611"></a>1611         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1612"></a>1612 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1613"></a>1613         def select_all_rows(options, join_dependency)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1614"></a>1614           connection.select_all(</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1615"></a>1615             construct_finder_sql_with_included_associations(options, join_dependency),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1616"></a>1616             "#{name} Load Including Associations"</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1617"></a>1617           )</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1618"></a>1618         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1619"></a>1619 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1620"></a>1620         def construct_finder_sql_with_included_associations(options, join_dependency)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1621"></a>1621           scope = scope(:find)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1622"></a>1622           sql = "SELECT #{column_aliases(join_dependency)} FROM #{(scope && scope[:from]) || options[:from] || quoted_table_name} "</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1623"></a>1623           sql << join_dependency.join_associations.collect{|join| join.association_join }.join</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1624"></a>1624 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1625"></a>1625           add_joins!(sql, options[:joins], scope)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1626"></a>1626           add_conditions!(sql, options[:conditions], scope)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1627"></a>1627           add_limited_ids_condition!(sql, options, join_dependency) if !using_limitable_reflections?(join_dependency.reflections) && ((scope && scope[:limit]) || options[:limit])</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1628"></a>1628 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1629"></a>1629           add_group!(sql, options[:group], options[:having], scope)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1630"></a>1630           add_order!(sql, options[:order], scope)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1631"></a>1631           add_limit!(sql, options, scope) if using_limitable_reflections?(join_dependency.reflections)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1632"></a>1632           add_lock!(sql, options, scope)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1633"></a>1633 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1634"></a>1634           return sanitize_sql(sql)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1635"></a>1635         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1636"></a>1636 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1637"></a>1637         def add_limited_ids_condition!(sql, options, join_dependency)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1638"></a>1638           unless (id_list = select_limited_ids_list(options, join_dependency)).empty?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1639"></a>1639             sql << "#{condition_word(sql)} #{connection.quote_table_name table_name}.#{primary_key} IN (#{id_list}) "</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1640"></a>1640           else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1641"></a>1641             throw :invalid_query</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1642"></a>1642           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1643"></a>1643         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1644"></a>1644 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1645"></a>1645         def select_limited_ids_list(options, join_dependency)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1646"></a>1646           pk = columns_hash[primary_key]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1647"></a>1647 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1648"></a>1648           connection.select_all(</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1649"></a>1649             construct_finder_sql_for_association_limiting(options, join_dependency),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1650"></a>1650             "#{name} Load IDs For Limited Eager Loading"</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1651"></a>1651           ).collect { |row| connection.quote(row[primary_key], pk) }.join(", ")</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1652"></a>1652         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1653"></a>1653 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1654"></a>1654         def construct_finder_sql_for_association_limiting(options, join_dependency)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1655"></a>1655           scope       = scope(:find)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1656"></a>1656 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1657"></a>1657           # Only join tables referenced in order or conditions since this is particularly slow on the pre-query.</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1658"></a>1658           tables_from_conditions = conditions_tables(options)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1659"></a>1659           tables_from_order      = order_tables(options)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1660"></a>1660           all_tables             = tables_from_conditions + tables_from_order</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1661"></a>1661           distinct_join_associations = all_tables.uniq.map{|table|</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1662"></a>1662             join_dependency.joins_for_table_name(table)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1663"></a>1663           }.flatten.compact.uniq</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1664"></a>1664 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1665"></a>1665           order = options[:order]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1666"></a>1666           if scoped_order = (scope && scope[:order])</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1667"></a>1667             order = order ? "#{order}, #{scoped_order}" : scoped_order</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1668"></a>1668           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1669"></a>1669 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1670"></a>1670           is_distinct = !options[:joins].blank? || include_eager_conditions?(options, tables_from_conditions) || include_eager_order?(options, tables_from_order)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1671"></a>1671           sql = "SELECT "</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1672"></a>1672           if is_distinct</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1673"></a>1673             sql << connection.distinct("#{connection.quote_table_name table_name}.#{primary_key}", order)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1674"></a>1674           else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1675"></a>1675             sql << primary_key</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1676"></a>1676           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1677"></a>1677           sql << " FROM #{connection.quote_table_name table_name} "</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1678"></a>1678 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1679"></a>1679           if is_distinct</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1680"></a>1680             sql << distinct_join_associations.collect { |assoc| assoc.association_join }.join</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1681"></a>1681             add_joins!(sql, options[:joins], scope)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1682"></a>1682           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1683"></a>1683 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1684"></a>1684           add_conditions!(sql, options[:conditions], scope)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1685"></a>1685           add_group!(sql, options[:group], options[:having], scope)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1686"></a>1686 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1687"></a>1687           if order && is_distinct</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1688"></a>1688             connection.add_order_by_for_association_limiting!(sql, :order => order)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1689"></a>1689           else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1690"></a>1690             add_order!(sql, options[:order], scope)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1691"></a>1691           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1692"></a>1692 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1693"></a>1693           add_limit!(sql, options, scope)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1694"></a>1694 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1695"></a>1695           return sanitize_sql(sql)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1696"></a>1696         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1697"></a>1697 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1698"></a>1698         def tables_in_string(string)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1699"></a>1699           return [] if string.blank?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1700"></a>1700           string.scan(/([\.a-zA-Z_]+).?\./).flatten</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1701"></a>1701         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1702"></a>1702 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1703"></a>1703         def tables_in_hash(hash)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1704"></a>1704           return [] if hash.blank?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1705"></a>1705           tables = hash.map do |key, value|</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1706"></a>1706             if value.is_a?(Hash)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1707"></a>1707               key.to_s</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1708"></a>1708             else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1709"></a>1709               tables_in_string(key) if key.is_a?(String)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1710"></a>1710             end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1711"></a>1711           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1712"></a>1712           tables.flatten.compact</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1713"></a>1713         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1714"></a>1714 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1715"></a>1715         def conditions_tables(options)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1716"></a>1716           # look in both sets of conditions</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1717"></a>1717           conditions = [scope(:find, :conditions), options[:conditions]].inject([]) do |all, cond|</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1718"></a>1718             case cond</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1719"></a>1719               when nil   then all</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1720"></a>1720               when Array then all << tables_in_string(cond.first)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1721"></a>1721               when Hash  then all << tables_in_hash(cond)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1722"></a>1722               else            all << tables_in_string(cond)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1723"></a>1723             end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1724"></a>1724           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1725"></a>1725           conditions.flatten</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1726"></a>1726         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1727"></a>1727 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1728"></a>1728         def order_tables(options)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1729"></a>1729           order = [options[:order], scope(:find, :order) ].join(", ")</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1730"></a>1730           return [] unless order && order.is_a?(String)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1731"></a>1731           tables_in_string(order)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1732"></a>1732         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1733"></a>1733 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1734"></a>1734         def selects_tables(options)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1735"></a>1735           select = options[:select]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1736"></a>1736           return [] unless select && select.is_a?(String)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1737"></a>1737           tables_in_string(select)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1738"></a>1738         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1739"></a>1739 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1740"></a>1740         def joined_tables(options)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1741"></a>1741           scope = scope(:find)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1742"></a>1742           joins = options[:joins]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1743"></a>1743           merged_joins = scope && scope[:joins] && joins ? merge_joins(scope[:joins], joins) : (joins || scope && scope[:joins])</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1744"></a>1744           [table_name] + case merged_joins</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1745"></a>1745           when Symbol, Hash, Array</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1746"></a>1746             if array_of_strings?(merged_joins)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1747"></a>1747               tables_in_string(merged_joins.join(' '))</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1748"></a>1748             else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1749"></a>1749               join_dependency = ActiveRecord::Associations::ClassMethods::InnerJoinDependency.new(self, merged_joins, nil)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1750"></a>1750               join_dependency.join_associations.collect {|join_association| [join_association.aliased_join_table_name, join_association.aliased_table_name]}.flatten.compact</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1751"></a>1751             end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1752"></a>1752           else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1753"></a>1753             tables_in_string(merged_joins)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1754"></a>1754           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1755"></a>1755         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1756"></a>1756 </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1757"></a>1757         # Checks if the conditions reference a table other than the current model table</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1758"></a>1758         def include_eager_conditions?(options, tables = nil, joined_tables = nil)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1759"></a>1759           ((tables || conditions_tables(options)) - (joined_tables || joined_tables(options))).any?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1760"></a>1760         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1761"></a>1761 </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1762"></a>1762         # Checks if the query order references a table other than the current model's table.</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1763"></a>1763         def include_eager_order?(options, tables = nil, joined_tables = nil)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1764"></a>1764           ((tables || order_tables(options)) - (joined_tables || joined_tables(options))).any?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1765"></a>1765         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1766"></a>1766 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1767"></a>1767         def include_eager_select?(options, joined_tables = nil)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1768"></a>1768           (selects_tables(options) - (joined_tables || joined_tables(options))).any?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1769"></a>1769         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1770"></a>1770 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1771"></a>1771         def references_eager_loaded_tables?(options)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1772"></a>1772           joined_tables = joined_tables(options)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1773"></a>1773           include_eager_order?(options, nil, joined_tables) || include_eager_conditions?(options, nil, joined_tables) || include_eager_select?(options, joined_tables)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1774"></a>1774         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1775"></a>1775 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1776"></a>1776         def using_limitable_reflections?(reflections)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1777"></a>1777           reflections.reject { |r| [ :belongs_to, :has_one ].include?(r.macro) }.length.zero?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1778"></a>1778         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1779"></a>1779 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1780"></a>1780         def column_aliases(join_dependency)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1781"></a>1781           join_dependency.joins.collect{|join| join.column_names_with_alias.collect{|column_name, aliased_name|</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1782"></a>1782               "#{connection.quote_table_name join.aliased_table_name}.#{connection.quote_column_name column_name} AS #{aliased_name}"}}.flatten.join(", ")</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1783"></a>1783         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1784"></a>1784 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1785"></a>1785         def add_association_callbacks(association_name, options)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1786"></a>1786           callbacks = %w(before_add after_add before_remove after_remove)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1787"></a>1787           callbacks.each do |callback_name|</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1788"></a>1788             full_callback_name = "#{callback_name}_for_#{association_name}"</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1789"></a>1789             defined_callbacks = options[callback_name.to_sym]</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1790"></a>1790             if options.has_key?(callback_name.to_sym)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1791"></a>1791               class_inheritable_reader full_callback_name.to_sym</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1792"></a>1792               write_inheritable_attribute(full_callback_name.to_sym, [defined_callbacks].flatten)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1793"></a>1793             else</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1794"></a>1794               write_inheritable_attribute(full_callback_name.to_sym, [])</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1795"></a>1795             end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1796"></a>1796           end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1797"></a>1797         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1798"></a>1798 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1799"></a>1799         def condition_word(sql)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1800"></a>1800           sql =~ /where/i ? " AND " : "WHERE "</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1801"></a>1801         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1802"></a>1802 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1803"></a>1803         def create_extension_modules(association_id, block_extension, extensions)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1804"></a>1804           if block_extension</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1805"></a>1805             extension_module_name = "#{self.to_s.demodulize}#{association_id.to_s.camelize}AssociationExtension"</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1806"></a>1806 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1807"></a>1807             silence_warnings do</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1808"></a>1808               self.parent.const_set(extension_module_name, Module.new(&block_extension))</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1809"></a>1809             end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1810"></a>1810             Array(extensions).push("#{self.parent}::#{extension_module_name}".constantize)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1811"></a>1811           else</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1812"></a>1812             Array(extensions)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1813"></a>1813           end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1814"></a>1814         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1815"></a>1815 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1816"></a>1816         class JoinDependency # :nodoc:</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1817"></a>1817           attr_reader :joins, :reflections, :table_aliases</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1818"></a>1818 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1819"></a>1819           def initialize(base, associations, joins)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1820"></a>1820             @joins                 = [JoinBase.new(base, joins)]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1821"></a>1821             @associations          = associations</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1822"></a>1822             @reflections           = []</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1823"></a>1823             @base_records_hash     = {}</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1824"></a>1824             @base_records_in_order = []</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1825"></a>1825             @table_aliases         = Hash.new { |aliases, table| aliases[table] = 0 }</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1826"></a>1826             @table_aliases[base.table_name] = 1</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1827"></a>1827             build(associations)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1828"></a>1828           end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1829"></a>1829 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1830"></a>1830           def join_associations</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1831"></a>1831             @joins[1..-1].to_a</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1832"></a>1832           end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1833"></a>1833 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1834"></a>1834           def join_base</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1835"></a>1835             @joins[0]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1836"></a>1836           end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1837"></a>1837 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1838"></a>1838           def instantiate(rows)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1839"></a>1839             rows.each_with_index do |row, i|</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1840"></a>1840               primary_id = join_base.record_id(row)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1841"></a>1841               unless @base_records_hash[primary_id]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1842"></a>1842                 @base_records_in_order << (@base_records_hash[primary_id] = join_base.instantiate(row))</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1843"></a>1843               end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1844"></a>1844               construct(@base_records_hash[primary_id], @associations, join_associations.dup, row)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1845"></a>1845             end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1846"></a>1846             remove_duplicate_results!(join_base.active_record, @base_records_in_order, @associations)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1847"></a>1847             return @base_records_in_order</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1848"></a>1848           end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1849"></a>1849 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1850"></a>1850           def remove_duplicate_results!(base, records, associations)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1851"></a>1851             case associations</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1852"></a>1852               when Symbol, String</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1853"></a>1853                 reflection = base.reflections[associations]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1854"></a>1854                 if reflection && [:has_many, :has_and_belongs_to_many].include?(reflection.macro)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1855"></a>1855                   records.each { |record| record.send(reflection.name).target.uniq! }</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1856"></a>1856                 end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1857"></a>1857               when Array</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1858"></a>1858                 associations.each do |association|</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1859"></a>1859                   remove_duplicate_results!(base, records, association)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1860"></a>1860                 end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1861"></a>1861               when Hash</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1862"></a>1862                 associations.keys.each do |name|</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1863"></a>1863                   reflection = base.reflections[name]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1864"></a>1864                   is_collection = [:has_many, :has_and_belongs_to_many].include?(reflection.macro)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1865"></a>1865 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1866"></a>1866                   parent_records = records.map do |record|</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1867"></a>1867                     descendant = record.send(reflection.name)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1868"></a>1868                     next unless descendant</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1869"></a>1869                     descendant.target.uniq! if is_collection</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1870"></a>1870                     descendant</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1871"></a>1871                   end.flatten.compact</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1872"></a>1872 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1873"></a>1873                   remove_duplicate_results!(reflection.klass, parent_records, associations[name]) unless parent_records.empty?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1874"></a>1874                 end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1875"></a>1875             end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1876"></a>1876           end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1877"></a>1877 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1878"></a>1878           def join_for_table_name(table_name)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1879"></a>1879             join = (@joins.select{|j|j.aliased_table_name == table_name.gsub(/^\"(.*)\"$/){$1} }.first) rescue nil</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1880"></a>1880             return join unless join.nil?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1881"></a>1881             @joins.select{|j|j.is_a?(JoinAssociation) && j.aliased_join_table_name == table_name.gsub(/^\"(.*)\"$/){$1} }.first rescue nil</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1882"></a>1882           end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1883"></a>1883 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1884"></a>1884           def joins_for_table_name(table_name)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1885"></a>1885             join = join_for_table_name(table_name)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1886"></a>1886             result = nil</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1887"></a>1887             if join && join.is_a?(JoinAssociation)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1888"></a>1888               result = [join]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1889"></a>1889               if join.parent && join.parent.is_a?(JoinAssociation)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1890"></a>1890                 result = joins_for_table_name(join.parent.aliased_table_name) +</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1891"></a>1891                          result</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1892"></a>1892               end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1893"></a>1893             end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1894"></a>1894             result</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1895"></a>1895           end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1896"></a>1896 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1897"></a>1897           protected</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1898"></a>1898             def build(associations, parent = nil)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1899"></a>1899               parent ||= @joins.last</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1900"></a>1900               case associations</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1901"></a>1901                 when Symbol, String</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1902"></a>1902                   reflection = parent.reflections[associations.to_s.intern] or</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1903"></a>1903                   raise ConfigurationError, "Association named '#{ associations }' was not found; perhaps you misspelled it?"</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1904"></a>1904                   @reflections << reflection</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1905"></a>1905                   @joins << build_join_association(reflection, parent)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1906"></a>1906                 when Array</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1907"></a>1907                   associations.each do |association|</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1908"></a>1908                     build(association, parent)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1909"></a>1909                   end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1910"></a>1910                 when Hash</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1911"></a>1911                   associations.keys.sort{|a,b|a.to_s<=>b.to_s}.each do |name|</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1912"></a>1912                     build(name, parent)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1913"></a>1913                     build(associations[name])</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1914"></a>1914                   end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1915"></a>1915                 else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1916"></a>1916                   raise ConfigurationError, associations.inspect</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1917"></a>1917               end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1918"></a>1918             end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1919"></a>1919 </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1920"></a>1920             # overridden in InnerJoinDependency subclass</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1921"></a>1921             def build_join_association(reflection, parent)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1922"></a>1922               JoinAssociation.new(reflection, self, parent)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1923"></a>1923             end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1924"></a>1924 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1925"></a>1925             def construct(parent, associations, joins, row)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1926"></a>1926               case associations</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1927"></a>1927                 when Symbol, String</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1928"></a>1928                   join = joins.detect{|j| j.reflection.name.to_s == associations.to_s && j.parent_table_name == parent.class.table_name }</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1929"></a>1929                   raise(ConfigurationError, "No such association") if join.nil?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1930"></a>1930 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1931"></a>1931                   joins.delete(join)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1932"></a>1932                   construct_association(parent, join, row)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1933"></a>1933                 when Array</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1934"></a>1934                   associations.each do |association|</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1935"></a>1935                     construct(parent, association, joins, row)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1936"></a>1936                   end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1937"></a>1937                 when Hash</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1938"></a>1938                   associations.keys.sort{|a,b|a.to_s<=>b.to_s}.each do |name|</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1939"></a>1939                     join = joins.detect{|j| j.reflection.name.to_s == name.to_s && j.parent_table_name == parent.class.table_name }</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1940"></a>1940                     raise(ConfigurationError, "No such association") if join.nil?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1941"></a>1941 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1942"></a>1942                     association = construct_association(parent, join, row)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1943"></a>1943                     joins.delete(join)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1944"></a>1944                     construct(association, associations[name], joins, row) if association</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1945"></a>1945                   end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1946"></a>1946                 else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1947"></a>1947                   raise ConfigurationError, associations.inspect</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1948"></a>1948               end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1949"></a>1949             end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1950"></a>1950 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1951"></a>1951             def construct_association(record, join, row)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1952"></a>1952               case join.reflection.macro</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1953"></a>1953                 when :has_many, :has_and_belongs_to_many</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1954"></a>1954                   collection = record.send(join.reflection.name)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1955"></a>1955                   collection.loaded</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1956"></a>1956 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1957"></a>1957                   return nil if record.id.to_s != join.parent.record_id(row).to_s or row[join.aliased_primary_key].nil?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1958"></a>1958                   association = join.instantiate(row)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1959"></a>1959                   collection.target.push(association)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1960"></a>1960                 when :has_one</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1961"></a>1961                   return if record.id.to_s != join.parent.record_id(row).to_s</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1962"></a>1962                   return if record.instance_variable_defined?("@#{join.reflection.name}")</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1963"></a>1963                   association = join.instantiate(row) unless row[join.aliased_primary_key].nil?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1964"></a>1964                   record.send("set_#{join.reflection.name}_target", association)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1965"></a>1965                 when :belongs_to</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1966"></a>1966                   return if record.id.to_s != join.parent.record_id(row).to_s or row[join.aliased_primary_key].nil?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1967"></a>1967                   association = join.instantiate(row)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1968"></a>1968                   record.send("set_#{join.reflection.name}_target", association)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1969"></a>1969                 else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1970"></a>1970                   raise ConfigurationError, "unknown macro: #{join.reflection.macro}"</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1971"></a>1971               end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1972"></a>1972               return association</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1973"></a>1973             end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1974"></a>1974 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1975"></a>1975           class JoinBase # :nodoc:</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1976"></a>1976             attr_reader :active_record, :table_joins</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1977"></a>1977             delegate    :table_name, :column_names, :primary_key, :reflections, :sanitize_sql, :to => :active_record</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1978"></a>1978 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1979"></a>1979             def initialize(active_record, joins = nil)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1980"></a>1980               @active_record = active_record</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1981"></a>1981               @cached_record = {}</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1982"></a>1982               @table_joins   = joins</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1983"></a>1983             end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1984"></a>1984 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1985"></a>1985             def aliased_prefix</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1986"></a>1986               "t0"</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1987"></a>1987             end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1988"></a>1988 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1989"></a>1989             def aliased_primary_key</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1990"></a>1990               "#{aliased_prefix}_r0"</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1991"></a>1991             end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1992"></a>1992 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1993"></a>1993             def aliased_table_name</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1994"></a>1994               active_record.table_name</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1995"></a>1995             end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line1996"></a>1996 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1997"></a>1997             def column_names_with_alias</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1998"></a>1998               unless defined?(@column_names_with_alias)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line1999"></a>1999                 @column_names_with_alias = []</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2000"></a>2000 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2001"></a>2001                 ([primary_key] + (column_names - [primary_key])).each_with_index do |column_name, i|</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2002"></a>2002                   @column_names_with_alias << [column_name, "#{aliased_prefix}_r#{i}"]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2003"></a>2003                 end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2004"></a>2004               end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2005"></a>2005 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2006"></a>2006               @column_names_with_alias</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2007"></a>2007             end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line2008"></a>2008 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line2009"></a>2009             def extract_record(row)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2010"></a>2010               column_names_with_alias.inject({}){|record, (cn, an)| record[cn] = row[an]; record}</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2011"></a>2011             end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line2012"></a>2012 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line2013"></a>2013             def record_id(row)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2014"></a>2014               row[aliased_primary_key]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2015"></a>2015             end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line2016"></a>2016 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line2017"></a>2017             def instantiate(row)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2018"></a>2018               @cached_record[record_id(row)] ||= active_record.send(:instantiate, extract_record(row))</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2019"></a>2019             end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2020"></a>2020           end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line2021"></a>2021 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line2022"></a>2022           class JoinAssociation < JoinBase # :nodoc:</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line2023"></a>2023             attr_reader :reflection, :parent, :aliased_table_name, :aliased_prefix, :aliased_join_table_name, :parent_table_name</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line2024"></a>2024             delegate    :options, :klass, :through_reflection, :source_reflection, :to => :reflection</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line2025"></a>2025 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line2026"></a>2026             def initialize(reflection, join_dependency, parent = nil)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2027"></a>2027               reflection.check_validity!</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2028"></a>2028               if reflection.options[:polymorphic]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2029"></a>2029                 raise EagerLoadPolymorphicError.new(reflection)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2030"></a>2030               end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2031"></a>2031 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2032"></a>2032               super(reflection.klass)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2033"></a>2033               @join_dependency    = join_dependency</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2034"></a>2034               @parent             = parent</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2035"></a>2035               @reflection         = reflection</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2036"></a>2036               @aliased_prefix     = "t#{ join_dependency.joins.size }"</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2037"></a>2037               @parent_table_name  = parent.active_record.table_name</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2038"></a>2038               @aliased_table_name = aliased_table_name_for(table_name)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2039"></a>2039 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2040"></a>2040               if reflection.macro == :has_and_belongs_to_many</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2041"></a>2041                 @aliased_join_table_name = aliased_table_name_for(reflection.options[:join_table], "_join")</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2042"></a>2042               end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2043"></a>2043 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2044"></a>2044               if [:has_many, :has_one].include?(reflection.macro) && reflection.options[:through]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2045"></a>2045                 @aliased_join_table_name = aliased_table_name_for(reflection.through_reflection.klass.table_name, "_join")</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2046"></a>2046               end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2047"></a>2047             end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line2048"></a>2048 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line2049"></a>2049             def association_join</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2050"></a>2050               connection = reflection.active_record.connection</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2051"></a>2051               join = case reflection.macro</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2052"></a>2052                 when :has_and_belongs_to_many</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2053"></a>2053                   " #{join_type} %s ON %s.%s = %s.%s " % [</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2054"></a>2054                      table_alias_for(options[:join_table], aliased_join_table_name),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2055"></a>2055                      connection.quote_table_name(aliased_join_table_name),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2056"></a>2056                      options[:foreign_key] || reflection.active_record.to_s.foreign_key,</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2057"></a>2057                      connection.quote_table_name(parent.aliased_table_name),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2058"></a>2058                      reflection.active_record.primary_key] +</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2059"></a>2059                   " #{join_type} %s ON %s.%s = %s.%s " % [</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2060"></a>2060                      table_name_and_alias,</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2061"></a>2061                      connection.quote_table_name(aliased_table_name),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2062"></a>2062                      klass.primary_key,</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2063"></a>2063                      connection.quote_table_name(aliased_join_table_name),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2064"></a>2064                      options[:association_foreign_key] || klass.to_s.foreign_key</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2065"></a>2065                      ]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2066"></a>2066                 when :has_many, :has_one</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2067"></a>2067                   case</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2068"></a>2068                     when reflection.options[:through]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2069"></a>2069                       through_conditions = through_reflection.options[:conditions] ? "AND #{interpolate_sql(sanitize_sql(through_reflection.options[:conditions]))}" : ''</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2070"></a>2070 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2071"></a>2071                       jt_foreign_key = jt_as_extra = jt_source_extra = jt_sti_extra = nil</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2072"></a>2072                       first_key = second_key = as_extra = nil</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2073"></a>2073 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2074"></a>2074                       if through_reflection.options[:as] # has_many :through against a polymorphic join</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2075"></a>2075                         jt_foreign_key = through_reflection.options[:as].to_s + '_id'</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2076"></a>2076                         jt_as_extra = " AND %s.%s = %s" % [</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2077"></a>2077                           connection.quote_table_name(aliased_join_table_name),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2078"></a>2078                           connection.quote_column_name(through_reflection.options[:as].to_s + '_type'),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2079"></a>2079                           klass.quote_value(parent.active_record.base_class.name)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2080"></a>2080                         ]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2081"></a>2081                       else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2082"></a>2082                         jt_foreign_key = through_reflection.primary_key_name</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2083"></a>2083                       end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2084"></a>2084 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2085"></a>2085                       case source_reflection.macro</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2086"></a>2086                       when :has_many</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2087"></a>2087                         if source_reflection.options[:as]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2088"></a>2088                           first_key   = "#{source_reflection.options[:as]}_id"</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2089"></a>2089                           second_key  = options[:foreign_key] || primary_key</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2090"></a>2090                           as_extra    = " AND %s.%s = %s" % [</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2091"></a>2091                             connection.quote_table_name(aliased_table_name),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2092"></a>2092                             connection.quote_column_name("#{source_reflection.options[:as]}_type"),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2093"></a>2093                             klass.quote_value(source_reflection.active_record.base_class.name)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2094"></a>2094                           ]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2095"></a>2095                         else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2096"></a>2096                           first_key   = through_reflection.klass.base_class.to_s.foreign_key</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2097"></a>2097                           second_key  = options[:foreign_key] || primary_key</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2098"></a>2098                         end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2099"></a>2099 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2100"></a>2100                         unless through_reflection.klass.descends_from_active_record?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2101"></a>2101                           jt_sti_extra = " AND %s.%s = %s" % [</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2102"></a>2102                             connection.quote_table_name(aliased_join_table_name),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2103"></a>2103                             connection.quote_column_name(through_reflection.active_record.inheritance_column),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2104"></a>2104                             through_reflection.klass.quote_value(through_reflection.klass.sti_name)]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2105"></a>2105                         end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2106"></a>2106                       when :belongs_to</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2107"></a>2107                         first_key = primary_key</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2108"></a>2108                         if reflection.options[:source_type]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2109"></a>2109                           second_key = source_reflection.association_foreign_key</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2110"></a>2110                           jt_source_extra = " AND %s.%s = %s" % [</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2111"></a>2111                             connection.quote_table_name(aliased_join_table_name),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2112"></a>2112                             connection.quote_column_name(reflection.source_reflection.options[:foreign_type]),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2113"></a>2113                             klass.quote_value(reflection.options[:source_type])</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2114"></a>2114                           ]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2115"></a>2115                         else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2116"></a>2116                           second_key = source_reflection.primary_key_name</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2117"></a>2117                         end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2118"></a>2118                       end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2119"></a>2119 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2120"></a>2120                       " #{join_type} %s ON (%s.%s = %s.%s%s%s%s) " % [</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2121"></a>2121                         table_alias_for(through_reflection.klass.table_name, aliased_join_table_name),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2122"></a>2122                         connection.quote_table_name(parent.aliased_table_name),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2123"></a>2123                         connection.quote_column_name(parent.primary_key),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2124"></a>2124                         connection.quote_table_name(aliased_join_table_name),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2125"></a>2125                         connection.quote_column_name(jt_foreign_key),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2126"></a>2126                         jt_as_extra, jt_source_extra, jt_sti_extra</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2127"></a>2127                       ] +</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2128"></a>2128                       " #{join_type} %s ON (%s.%s = %s.%s%s) " % [</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2129"></a>2129                         table_name_and_alias,</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2130"></a>2130                         connection.quote_table_name(aliased_table_name),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2131"></a>2131                         connection.quote_column_name(first_key),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2132"></a>2132                         connection.quote_table_name(aliased_join_table_name),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2133"></a>2133                         connection.quote_column_name(second_key),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2134"></a>2134                         as_extra</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2135"></a>2135                       ]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2136"></a>2136 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2137"></a>2137                     when reflection.options[:as] && [:has_many, :has_one].include?(reflection.macro)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2138"></a>2138                       " #{join_type} %s ON %s.%s = %s.%s AND %s.%s = %s" % [</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2139"></a>2139                         table_name_and_alias,</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2140"></a>2140                         connection.quote_table_name(aliased_table_name),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2141"></a>2141                         "#{reflection.options[:as]}_id",</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2142"></a>2142                         connection.quote_table_name(parent.aliased_table_name),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2143"></a>2143                         parent.primary_key,</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2144"></a>2144                         connection.quote_table_name(aliased_table_name),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2145"></a>2145                         "#{reflection.options[:as]}_type",</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2146"></a>2146                         klass.quote_value(parent.active_record.base_class.name)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2147"></a>2147                       ]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2148"></a>2148                     else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2149"></a>2149                       foreign_key = options[:foreign_key] || reflection.active_record.name.foreign_key</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2150"></a>2150                       " #{join_type} %s ON %s.%s = %s.%s " % [</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2151"></a>2151                         table_name_and_alias,</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2152"></a>2152                         aliased_table_name,</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2153"></a>2153                         foreign_key,</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2154"></a>2154                         parent.aliased_table_name,</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2155"></a>2155                         reflection.options[:primary_key] || parent.primary_key</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2156"></a>2156                       ]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2157"></a>2157                   end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2158"></a>2158                 when :belongs_to</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2159"></a>2159                   " #{join_type} %s ON %s.%s = %s.%s " % [</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2160"></a>2160                      table_name_and_alias,</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2161"></a>2161                      connection.quote_table_name(aliased_table_name),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2162"></a>2162                      reflection.klass.primary_key,</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2163"></a>2163                      connection.quote_table_name(parent.aliased_table_name),</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2164"></a>2164                      options[:foreign_key] || reflection.primary_key_name</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2165"></a>2165                     ]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2166"></a>2166                 else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2167"></a>2167                   ""</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2168"></a>2168               end || ''</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2169"></a>2169               join << %(AND %s) % [</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2170"></a>2170                 klass.send(:type_condition, aliased_table_name)] unless klass.descends_from_active_record?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2171"></a>2171 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2172"></a>2172               [through_reflection, reflection].each do |ref|</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2173"></a>2173                 join << "AND #{interpolate_sql(sanitize_sql(ref.options[:conditions], aliased_table_name))} " if ref && ref.options[:conditions]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2174"></a>2174               end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2175"></a>2175 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2176"></a>2176               join</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2177"></a>2177             end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line2178"></a>2178 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line2179"></a>2179             protected</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line2180"></a>2180 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line2181"></a>2181               def aliased_table_name_for(name, suffix = nil)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2182"></a>2182                 if !parent.table_joins.blank? && parent.table_joins.to_s.downcase =~ %r{join(\s+\w+)?\s+#{active_record.connection.quote_table_name name.downcase}\son}</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2183"></a>2183                   @join_dependency.table_aliases[name] += 1</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2184"></a>2184                 end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2185"></a>2185 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2186"></a>2186                 unless @join_dependency.table_aliases[name].zero?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2187"></a>2187                   # if the table name has been used, then use an alias</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2188"></a>2188                   name = active_record.connection.table_alias_for "#{pluralize(reflection.name)}_#{parent_table_name}#{suffix}"</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2189"></a>2189                   table_index = @join_dependency.table_aliases[name]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2190"></a>2190                   @join_dependency.table_aliases[name] += 1</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2191"></a>2191                   name = name[0..active_record.connection.table_alias_length-3] + "_#{table_index+1}" if table_index > 0</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2192"></a>2192                 else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2193"></a>2193                   @join_dependency.table_aliases[name] += 1</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2194"></a>2194                 end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2195"></a>2195 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2196"></a>2196                 name</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2197"></a>2197               end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line2198"></a>2198 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line2199"></a>2199               def pluralize(table_name)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2200"></a>2200                 ActiveRecord::Base.pluralize_table_names ? table_name.to_s.pluralize : table_name</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2201"></a>2201               end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line2202"></a>2202 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line2203"></a>2203               def table_alias_for(table_name, table_alias)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2204"></a>2204                  "#{reflection.active_record.connection.quote_table_name(table_name)} #{table_alias if table_name != table_alias}".strip</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2205"></a>2205               end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line2206"></a>2206 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line2207"></a>2207               def table_name_and_alias</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2208"></a>2208                 table_alias_for table_name, @aliased_table_name</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2209"></a>2209               end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line2210"></a>2210 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line2211"></a>2211               def interpolate_sql(sql)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2212"></a>2212                 instance_eval("%@#{sql.gsub('@', '\@')}@")</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2213"></a>2213               end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line2214"></a>2214 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line2215"></a>2215             private</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line2216"></a>2216               def join_type</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2217"></a>2217                 "LEFT OUTER JOIN"</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2218"></a>2218               end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2219"></a>2219           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2220"></a>2220         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line2221"></a>2221 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line2222"></a>2222         class InnerJoinDependency < JoinDependency # :nodoc:</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line2223"></a>2223           protected</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line2224"></a>2224             def build_join_association(reflection, parent)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2225"></a>2225               InnerJoinAssociation.new(reflection, self, parent)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2226"></a>2226             end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line2227"></a>2227 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line2228"></a>2228           class InnerJoinAssociation < JoinAssociation</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line2229"></a>2229             private</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line2230"></a>2230               def join_type</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2231"></a>2231                 "INNER JOIN"</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2232"></a>2232               end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2233"></a>2233           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2234"></a>2234         end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2235"></a>2235 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2236"></a>2236     end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2237"></a>2237   end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line2238"></a>2238 end</pre></td>
        </tr>
      
      </tbody>
    </table>
    <hr/>
    <p>Generated on Thu Dec 17 11:11:17 -0800 2009 with <a href="http://github.com/relevance/rcov">rcov 0.8.3.4</a></p>
  </body>
</html>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>/Users/alainbloch/.gem/ruby/1.8/gems/activerecord-2.3.4/lib/active_record/associations/association_collection.rb</title>
    <link href="screen.css" media="screen" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="rcov.js"></script>
  </head>
  <body>
    <h3>/Users/alainbloch/.gem/ruby/1.8/gems/activerecord-2.3.4/lib/active_record/associations/association_collection.rb</h3>
    <p>Generated on Thu Dec 17 11:11:17 -0800 2009 with <a href="http://github.com/relevance/rcov">rcov 0.8.3.4</a></p>
    
    <hr />
      <pre>
        <span class='marked'>Code reported as executed by Ruby looks like this...</span><span class='marked1'>and this: this line is also marked as covered.</span><span class='inferred'>Lines considered as run by rcov, but not reported by Ruby, look like this,</span><span class='inferred1'>and this: these lines were inferred by rcov (using simple heuristics).</span><span class='uncovered'>Finally, here&apos;s a line marked as not executed.</span>
      </pre>
    <table class='report'>
      <thead>
        <tr>
          <td class='heading'>Name</td>
          <td class='heading'>Total lines</td>
          <td class='heading'>Lines of code</td>
          <td class='heading'>Total coverage</td>
          <td class='heading'>Code coverage</td>
        </tr>
      </thead>
      <tbody>
        <!-- alternate light/dark here -->
        <tr class='light'>
          <td>/Users/alainbloch/.gem/ruby/1.8/gems/activerecord-2.3.4/lib/active_record/associations/association_collection.rb</td>
          <td class='lines_total'><tt>475</tt></td>
          <td class='lines_code'><tt>338</tt></td>
          <td>
            <table cellspacing='0' cellpadding='0' align='right'>
              <tr>
                <td><tt class='coverage_total'>55.37%</tt>&nbsp;</td>
                <td>
                  <table cellspacing='0' class='percent_graph' cellpadding='0' width='100'>
                    <tr>
                      <td class='covered' width='55'></td>
                      <td class='uncovered' width='45'></td>
                    </tr>
                  </table>
                </td>
              </tr>
            </table>
          </td>
          <td>
            <table cellspacing='0' cellpadding='0' align='right'>
              <tr>
                <td><tt class='coverage_code'>40.53%</tt>&nbsp;</td>
                <td>
                  <table cellspacing='0' class='percent_graph' cellpadding='0' width='100'>
                    <tr>
                      <td class='covered' width='41'/>
                      <td class='uncovered' width='59'/>
                    </tr>
                  </table>
                </td>
              </tr>
            </table>
          </td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line1"></a>1 require 'set'</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line2"></a>2 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line3"></a>3 module ActiveRecord</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line4"></a>4   module Associations</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line5"></a>5     # AssociationCollection is an abstract class that provides common stuff to</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line6"></a>6     # ease the implementation of association proxies that represent</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line7"></a>7     # collections. See the class hierarchy in AssociationProxy.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line8"></a>8     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line9"></a>9     # You need to be careful with assumptions regarding the target: The proxy</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line10"></a>10     # does not fetch records from the database until it needs them, but new</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line11"></a>11     # ones created with +build+ are added to the target. So, the target may be</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line12"></a>12     # non-empty and still lack children waiting to be read from the database.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line13"></a>13     # If you look directly to the database you cannot assume that's the entire</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line14"></a>14     # collection because new records may have beed added to the target, etc.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line15"></a>15     #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line16"></a>16     # If you need to work on all current children, new and existing records,</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line17"></a>17     # +load_target+ and the +loaded+ flag are your friends.</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line18"></a>18     class AssociationCollection < AssociationProxy #:nodoc:</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line19"></a>19       def initialize(owner, reflection)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line20"></a>20         super</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line21"></a>21         construct_sql</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line22"></a>22       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line23"></a>23       </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line24"></a>24       def find(*args)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line25"></a>25         options = args.extract_options!</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line26"></a>26 </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line27"></a>27         # If using a custom finder_sql, scan the entire collection.</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line28"></a>28         if @reflection.options[:finder_sql]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line29"></a>29           expects_array = args.first.kind_of?(Array)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line30"></a>30           ids           = args.flatten.compact.uniq.map { |arg| arg.to_i }</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line31"></a>31 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line32"></a>32           if ids.size == 1</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line33"></a>33             id = ids.first</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line34"></a>34             record = load_target.detect { |r| id == r.id }</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line35"></a>35             expects_array ? [ record ] : record</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line36"></a>36           else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line37"></a>37             load_target.select { |r| ids.include?(r.id) }</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line38"></a>38           end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line39"></a>39         else</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line40"></a>40           conditions = "#{@finder_sql}"</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line41"></a>41           if sanitized_conditions = sanitize_sql(options[:conditions])</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line42"></a>42             conditions << " AND (#{sanitized_conditions})"</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line43"></a>43           end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line44"></a>44           </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line45"></a>45           options[:conditions] = conditions</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line46"></a>46 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line47"></a>47           if options[:order] && @reflection.options[:order]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line48"></a>48             options[:order] = "#{options[:order]}, #{@reflection.options[:order]}"</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line49"></a>49           elsif @reflection.options[:order]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line50"></a>50             options[:order] = @reflection.options[:order]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line51"></a>51           end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line52"></a>52           </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line53"></a>53           # Build options specific to association</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line54"></a>54           construct_find_options!(options)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line55"></a>55           </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line56"></a>56           merge_options_from_reflection!(options)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line57"></a>57           </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line58"></a>58           # Pass through args exactly as we received them.</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line59"></a>59           args << options</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line60"></a>60           @reflection.klass.find(*args)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line61"></a>61         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line62"></a>62       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line63"></a>63 </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line64"></a>64       # Fetches the first one using SQL if possible.</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line65"></a>65       def first(*args)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line66"></a>66         if fetch_first_or_last_using_find?(args)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line67"></a>67           find(:first, *args)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line68"></a>68         else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line69"></a>69           load_target unless loaded?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line70"></a>70           @target.first(*args)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line71"></a>71         end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line72"></a>72       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line73"></a>73 </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line74"></a>74       # Fetches the last one using SQL if possible.</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line75"></a>75       def last(*args)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line76"></a>76         if fetch_first_or_last_using_find?(args)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line77"></a>77           find(:last, *args)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line78"></a>78         else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line79"></a>79           load_target unless loaded?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line80"></a>80           @target.last(*args)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line81"></a>81         end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line82"></a>82       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line83"></a>83 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line84"></a>84       def to_ary</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line85"></a>85         load_target</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line86"></a>86         if @target.is_a?(Array)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line87"></a>87           @target.to_ary</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line88"></a>88         else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line89"></a>89           Array(@target)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line90"></a>90         end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line91"></a>91       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line92"></a>92 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line93"></a>93       def reset</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line94"></a>94         reset_target!</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line95"></a>95         @loaded = false</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line96"></a>96       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line97"></a>97 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line98"></a>98       def build(attributes = {}, &block)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line99"></a>99         if attributes.is_a?(Array)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line100"></a>100           attributes.collect { |attr| build(attr, &block) }</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line101"></a>101         else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line102"></a>102           build_record(attributes) do |record|</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line103"></a>103             block.call(record) if block_given?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line104"></a>104             set_belongs_to_association_for(record)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line105"></a>105           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line106"></a>106         end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line107"></a>107       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line108"></a>108 </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line109"></a>109       # Add +records+ to this association.  Returns +self+ so method calls may be chained.  </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line110"></a>110       # Since << flattens its argument list and inserts each record, +push+ and +concat+ behave identically.</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line111"></a>111       def <<(*records)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line112"></a>112         result = true</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line113"></a>113         load_target if @owner.new_record?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line114"></a>114 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line115"></a>115         transaction do</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line116"></a>116           flatten_deeper(records).each do |record|</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line117"></a>117             raise_on_type_mismatch(record)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line118"></a>118             add_record_to_target_with_callbacks(record) do |r|</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line119"></a>119               result &&= insert_record(record) unless @owner.new_record?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line120"></a>120             end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line121"></a>121           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line122"></a>122         end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line123"></a>123 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line124"></a>124         result && self</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line125"></a>125       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line126"></a>126 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line127"></a>127       alias_method :push, :<<</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line128"></a>128       alias_method :concat, :<<</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line129"></a>129 </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line130"></a>130       # Starts a transaction in the association class's database connection.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line131"></a>131       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line132"></a>132       #   class Author < ActiveRecord::Base</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line133"></a>133       #     has_many :books</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line134"></a>134       #   end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line135"></a>135       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line136"></a>136       #   Author.find(:first).books.transaction do</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line137"></a>137       #     # same effect as calling Book.transaction</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line138"></a>138       #   end</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line139"></a>139       def transaction(*args)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line140"></a>140         @reflection.klass.transaction(*args) do</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line141"></a>141           yield</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line142"></a>142         end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line143"></a>143       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line144"></a>144 </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line145"></a>145       # Remove all records from this association</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line146"></a>146       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line147"></a>147       # See delete for more info.</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line148"></a>148       def delete_all</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line149"></a>149         load_target</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line150"></a>150         delete(@target)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line151"></a>151         reset_target!</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line152"></a>152       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line153"></a>153       </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line154"></a>154       # Calculate sum using SQL, not Enumerable</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line155"></a>155       def sum(*args)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line156"></a>156         if block_given?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line157"></a>157           calculate(:sum, *args) { |*block_args| yield(*block_args) }</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line158"></a>158         else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line159"></a>159           calculate(:sum, *args)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line160"></a>160         end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line161"></a>161       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line162"></a>162 </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line163"></a>163       # Count all records using SQL. If the +:counter_sql+ option is set for the association, it will</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line164"></a>164       # be used for the query. If no +:counter_sql+ was supplied, but +:finder_sql+ was set, the</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line165"></a>165       # descendant's +construct_sql+ method will have set :counter_sql automatically.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line166"></a>166       # Otherwise, construct options and pass them with scope to the target class's +count+.</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line167"></a>167       def count(*args)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line168"></a>168         if @reflection.options[:counter_sql]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line169"></a>169           @reflection.klass.count_by_sql(@counter_sql)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line170"></a>170         else</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line171"></a>171           column_name, options = @reflection.klass.send(:construct_count_options_from_args, *args)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line172"></a>172           if @reflection.options[:uniq]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line173"></a>173             # This is needed because 'SELECT count(DISTINCT *)..' is not valid SQL.</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line174"></a>174             column_name = "#{@reflection.quoted_table_name}.#{@reflection.klass.primary_key}" if column_name == :all</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line175"></a>175             options.merge!(:distinct => true)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line176"></a>176           end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line177"></a>177 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line178"></a>178           value = @reflection.klass.send(:with_scope, construct_scope) { @reflection.klass.count(column_name, options) }</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line179"></a>179 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line180"></a>180           limit  = @reflection.options[:limit]</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line181"></a>181           offset = @reflection.options[:offset]</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line182"></a>182 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line183"></a>183           if limit || offset</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line184"></a>184             [ [value - offset.to_i, 0].max, limit.to_i ].min</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line185"></a>185           else</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line186"></a>186             value</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line187"></a>187           end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line188"></a>188         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line189"></a>189       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line190"></a>190 </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line191"></a>191       # Removes +records+ from this association calling +before_remove+ and</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line192"></a>192       # +after_remove+ callbacks.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line193"></a>193       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line194"></a>194       # This method is abstract in the sense that +delete_records+ has to be</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line195"></a>195       # provided by descendants. Note this method does not imply the records</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line196"></a>196       # are actually removed from the database, that depends precisely on</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line197"></a>197       # +delete_records+. They are in any case removed from the collection.</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line198"></a>198       def delete(*records)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line199"></a>199         remove_records(records) do |records, old_records|</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line200"></a>200           delete_records(old_records) if old_records.any?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line201"></a>201           records.each { |record| @target.delete(record) }</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line202"></a>202         end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line203"></a>203       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line204"></a>204 </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line205"></a>205       # Destroy +records+ and remove them from this association calling</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line206"></a>206       # +before_remove+ and +after_remove+ callbacks.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line207"></a>207       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line208"></a>208       # Note that this method will _always_ remove records from the database</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line209"></a>209       # ignoring the +:dependent+ option.</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line210"></a>210       def destroy(*records)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line211"></a>211         records = find(records) if records.any? {|record| record.kind_of?(Fixnum) || record.kind_of?(String)}</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line212"></a>212         remove_records(records) do |records, old_records|</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line213"></a>213           old_records.each { |record| record.destroy }</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line214"></a>214         end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line215"></a>215 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line216"></a>216         load_target</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line217"></a>217       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line218"></a>218 </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line219"></a>219       # Removes all records from this association.  Returns +self+ so method calls may be chained.</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line220"></a>220       def clear</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line221"></a>221         return self if length.zero? # forces load_target if it hasn't happened already</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line222"></a>222 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line223"></a>223         if @reflection.options[:dependent] && @reflection.options[:dependent] == :destroy</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line224"></a>224           destroy_all</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line225"></a>225         else          </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line226"></a>226           delete_all</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line227"></a>227         end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line228"></a>228 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line229"></a>229         self</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line230"></a>230       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line231"></a>231 </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line232"></a>232       # Destory all the records from this association.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line233"></a>233       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line234"></a>234       # See destroy for more info.</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line235"></a>235       def destroy_all</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line236"></a>236         load_target</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line237"></a>237         destroy(@target)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line238"></a>238         reset_target!</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line239"></a>239       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line240"></a>240 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line241"></a>241       def create(attrs = {})</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line242"></a>242         if attrs.is_a?(Array)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line243"></a>243           attrs.collect { |attr| create(attr) }</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line244"></a>244         else</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line245"></a>245           create_record(attrs) do |record|</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line246"></a>246             yield(record) if block_given?</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line247"></a>247             record.save</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line248"></a>248           end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line249"></a>249         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line250"></a>250       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line251"></a>251 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line252"></a>252       def create!(attrs = {})</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line253"></a>253         create_record(attrs) do |record|</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line254"></a>254           yield(record) if block_given?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line255"></a>255           record.save!</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line256"></a>256         end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line257"></a>257       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line258"></a>258 </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line259"></a>259       # Returns the size of the collection by executing a SELECT COUNT(*)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line260"></a>260       # query if the collection hasn't been loaded, and calling</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line261"></a>261       # <tt>collection.size</tt> if it has.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line262"></a>262       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line263"></a>263       # If the collection has been already loaded +size+ and +length+ are</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line264"></a>264       # equivalent. If not and you are going to need the records anyway</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line265"></a>265       # +length+ will take one less query. Otherwise +size+ is more efficient.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line266"></a>266       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line267"></a>267       # This method is abstract in the sense that it relies on</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line268"></a>268       # +count_records+, which is a method descendants have to provide.</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line269"></a>269       def size</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line270"></a>270         if @owner.new_record? || (loaded? && !@reflection.options[:uniq])</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line271"></a>271           @target.size</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line272"></a>272         elsif !loaded? && @reflection.options[:group]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line273"></a>273           load_target.size</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line274"></a>274         elsif !loaded? && !@reflection.options[:uniq] && @target.is_a?(Array)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line275"></a>275           unsaved_records = @target.select { |r| r.new_record? }</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line276"></a>276           unsaved_records.size + count_records</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line277"></a>277         else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line278"></a>278           count_records</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line279"></a>279         end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line280"></a>280       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line281"></a>281 </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line282"></a>282       # Returns the size of the collection calling +size+ on the target.</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line283"></a>283       #</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line284"></a>284       # If the collection has been already loaded +length+ and +size+ are</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line285"></a>285       # equivalent. If not and you are going to need the records anyway this</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line286"></a>286       # method will take one less query. Otherwise +size+ is more efficient.</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line287"></a>287       def length</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line288"></a>288         load_target.size</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line289"></a>289       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line290"></a>290 </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line291"></a>291       # Equivalent to <tt>collection.size.zero?</tt>. If the collection has</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line292"></a>292       # not been already loaded and you are going to fetch the records anyway</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line293"></a>293       # it is better to check <tt>collection.length.zero?</tt>.</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line294"></a>294       def empty?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line295"></a>295         size.zero?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line296"></a>296       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line297"></a>297 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line298"></a>298       def any?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line299"></a>299         if block_given?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line300"></a>300           method_missing(:any?) { |*block_args| yield(*block_args) }</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line301"></a>301         else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line302"></a>302           !empty?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line303"></a>303         end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line304"></a>304       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line305"></a>305 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line306"></a>306       def uniq(collection = self)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line307"></a>307         seen = Set.new</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line308"></a>308         collection.inject([]) do |kept, record|</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line309"></a>309           unless seen.include?(record.id)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line310"></a>310             kept << record</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line311"></a>311             seen << record.id</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line312"></a>312           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line313"></a>313           kept</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line314"></a>314         end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line315"></a>315       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line316"></a>316 </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line317"></a>317       # Replace this collection with +other_array+</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line318"></a>318       # This will perform a diff and delete/add only records that have changed.</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line319"></a>319       def replace(other_array)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line320"></a>320         other_array.each { |val| raise_on_type_mismatch(val) }</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line321"></a>321 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line322"></a>322         load_target</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line323"></a>323         other   = other_array.size < 100 ? other_array : other_array.to_set</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line324"></a>324         current = @target.size < 100 ? @target : @target.to_set</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line325"></a>325 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line326"></a>326         transaction do</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line327"></a>327           delete(@target.select { |v| !other.include?(v) })</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line328"></a>328           concat(other_array.select { |v| !current.include?(v) })</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line329"></a>329         end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line330"></a>330       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line331"></a>331 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line332"></a>332       def include?(record)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line333"></a>333         return false unless record.is_a?(@reflection.klass)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line334"></a>334         load_target if @reflection.options[:finder_sql] && !loaded?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line335"></a>335         return @target.include?(record) if loaded?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line336"></a>336         exists?(record)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line337"></a>337       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line338"></a>338 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line339"></a>339       def proxy_respond_to?(method, include_private = false)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line340"></a>340         super || @reflection.klass.respond_to?(method, include_private)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line341"></a>341       end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line342"></a>342 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line343"></a>343       protected</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line344"></a>344         def construct_find_options!(options)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line345"></a>345         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line346"></a>346         </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line347"></a>347         def load_target</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line348"></a>348           if !@owner.new_record? || foreign_key_present</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line349"></a>349             begin</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line350"></a>350               if !loaded?</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line351"></a>351                 if @target.is_a?(Array) && @target.any?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line352"></a>352                   @target = find_target + @target.find_all {|t| t.new_record? }</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line353"></a>353                 else</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line354"></a>354                   @target = find_target</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line355"></a>355                 end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line356"></a>356               end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line357"></a>357             rescue ActiveRecord::RecordNotFound</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line358"></a>358               reset</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line359"></a>359             end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line360"></a>360           end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line361"></a>361 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line362"></a>362           loaded if target</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line363"></a>363           target</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line364"></a>364         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line365"></a>365         </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line366"></a>366         def method_missing(method, *args)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line367"></a>367           if @target.respond_to?(method) || (!@reflection.klass.respond_to?(method) && Class.respond_to?(method))</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line368"></a>368             if block_given?</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line369"></a>369               super { |*block_args| yield(*block_args) }</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line370"></a>370             else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line371"></a>371               super</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line372"></a>372             end</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line373"></a>373           elsif @reflection.klass.scopes.include?(method)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line374"></a>374             @reflection.klass.scopes[method].call(self, *args)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line375"></a>375           else          </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line376"></a>376             with_scope(construct_scope) do</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line377"></a>377               if block_given?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line378"></a>378                 @reflection.klass.send(method, *args) { |*block_args| yield(*block_args) }</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line379"></a>379               else</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line380"></a>380                 @reflection.klass.send(method, *args)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line381"></a>381               end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line382"></a>382             end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line383"></a>383           end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line384"></a>384         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line385"></a>385 </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line386"></a>386         # overloaded in derived Association classes to provide useful scoping depending on association type.</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line387"></a>387         def construct_scope</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line388"></a>388           {}</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line389"></a>389         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line390"></a>390 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line391"></a>391         def reset_target!</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line392"></a>392           @target = Array.new</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line393"></a>393         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line394"></a>394 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line395"></a>395         def find_target</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line396"></a>396           records =</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line397"></a>397             if @reflection.options[:finder_sql]</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line398"></a>398               @reflection.klass.find_by_sql(@finder_sql)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line399"></a>399             else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line400"></a>400               find(:all)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line401"></a>401             end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line402"></a>402 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line403"></a>403           @reflection.options[:uniq] ? uniq(records) : records</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line404"></a>404         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line405"></a>405 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line406"></a>406       private</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line407"></a>407 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line408"></a>408         def create_record(attrs)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line409"></a>409           attrs.update(@reflection.options[:conditions]) if @reflection.options[:conditions].is_a?(Hash)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line410"></a>410           ensure_owner_is_not_new</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line411"></a>411           record = @reflection.klass.send(:with_scope, :create => construct_scope[:create]) do</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line412"></a>412             @reflection.build_association(attrs)</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line413"></a>413           end</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line414"></a>414           if block_given?</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line415"></a>415             add_record_to_target_with_callbacks(record) { |*block_args| yield(*block_args) }</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line416"></a>416           else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line417"></a>417             add_record_to_target_with_callbacks(record)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line418"></a>418           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line419"></a>419         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line420"></a>420 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line421"></a>421         def build_record(attrs)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line422"></a>422           attrs.update(@reflection.options[:conditions]) if @reflection.options[:conditions].is_a?(Hash)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line423"></a>423           record = @reflection.build_association(attrs)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line424"></a>424           if block_given?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line425"></a>425             add_record_to_target_with_callbacks(record) { |*block_args| yield(*block_args) }</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line426"></a>426           else</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line427"></a>427             add_record_to_target_with_callbacks(record)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line428"></a>428           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line429"></a>429         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line430"></a>430 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line431"></a>431         def add_record_to_target_with_callbacks(record)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line432"></a>432           callback(:before_add, record)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line433"></a>433           yield(record) if block_given?</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line434"></a>434           @target ||= [] unless loaded?</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line435"></a>435           @target << record unless @reflection.options[:uniq] && @target.include?(record)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line436"></a>436           callback(:after_add, record)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line437"></a>437           record</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line438"></a>438         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line439"></a>439 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line440"></a>440         def remove_records(*records)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line441"></a>441           records = flatten_deeper(records)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line442"></a>442           records.each { |record| raise_on_type_mismatch(record) }</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line443"></a>443 </pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line444"></a>444           transaction do</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line445"></a>445             records.each { |record| callback(:before_remove, record) }</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line446"></a>446             old_records = records.reject { |r| r.new_record? }</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line447"></a>447             yield(records, old_records)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line448"></a>448             records.each { |record| callback(:after_remove, record) }</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line449"></a>449           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line450"></a>450         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line451"></a>451 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line452"></a>452         def callback(method, record)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line453"></a>453           callbacks_for(method).each do |callback|</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line454"></a>454             ActiveSupport::Callbacks::Callback.new(method, callback, record).call(@owner, record)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line455"></a>455           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line456"></a>456         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line457"></a>457 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line458"></a>458         def callbacks_for(callback_name)</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line459"></a>459           full_callback_name = "#{callback_name}_for_#{@reflection.name}"</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line460"></a>460           @owner.class.read_inheritable_attribute(full_callback_name.to_sym) || []</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line461"></a>461         end   </pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line462"></a>462         </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line463"></a>463         def ensure_owner_is_not_new</pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line464"></a>464           if @owner.new_record?</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line465"></a>465             raise ActiveRecord::RecordNotSaved, "You cannot call create unless the parent is saved"</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line466"></a>466           end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line467"></a>467         end</pre></td>
        </tr>
      
        
        
        <tr class="inferred">
          <td colspan="5"><pre><a name="line468"></a>468 </pre></td>
        </tr>
      
        
        
        <tr class="marked">
          <td colspan="5"><pre><a name="line469"></a>469         def fetch_first_or_last_using_find?(args)</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line470"></a>470           args.first.kind_of?(Hash) || !(loaded? || @owner.new_record? || @reflection.options[:finder_sql] ||</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line471"></a>471                                          @target.any? { |record| record.new_record? } || args.first.kind_of?(Integer))</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line472"></a>472         end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line473"></a>473     end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line474"></a>474   end</pre></td>
        </tr>
      
        
        
        <tr class="uncovered">
          <td colspan="5"><pre><a name="line475"></a>475 end</pre></td>
        </tr>
      
      </tbody>
    </table>
    <hr/>
    <p>Generated on Thu Dec 17 11:11:17 -0800 2009 with <a href="http://github.com/relevance/rcov">rcov 0.8.3.4</a></p>
  </body>
</html>
